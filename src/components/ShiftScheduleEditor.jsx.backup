import React, { useState, useMemo, useEffect, useCallback, useRef } from 'react';
import { format, addDays, addMonths } from 'date-fns';
import { ja } from 'date-fns/locale';
import { uuidv7 } from 'uuidv7';
import { useScheduleQuery } from '../hooks/useScheduleQuery';
import { 
  Download, 
  Save, 
  RotateCcw, 
  Calendar, 
  Users, 
  UserPlus,
  FileText,
  Table,
  Printer,
  BarChart3,
  ChevronLeft,
  ChevronRight,
  Settings,
  Plus,
  Trash2,
  Edit,
  Maximize,
  Sparkles,
  TableProperties,
  RefreshCw,
  X
} from 'lucide-react';

const ShiftScheduleEditor = () => {
  // Month navigation state - starting from current month (July-August)
  const [currentMonthIndex, setCurrentMonthIndex] = useState(6); // 6 = July-August (0-indexed)
  const [currentScheduleId, setCurrentScheduleId] = useState(null);
  const [schedulesByMonth, setSchedulesByMonth] = useState({}); // Store schedules for each month
  const [staffMembersByMonth, setStaffMembersByMonth] = useState({}); // Store staff members for each month
  const {
    scheduleData: supabaseScheduleData,
    isConnected,
    isLoading,
    isSaving,
    error,
    saveSchedule: saveScheduleData,
    deleteSchedule: deleteScheduleData,
    deleteAllSchedules: deleteAllSchedulesData,
    autoSave,
    clearError,
    lastSyncTime
  } = useScheduleQuery(currentScheduleId);
  


  // Function to migrate staff members to ensure they have all required properties
  const migrateStaffMembers = (staffList) => {
    const defaultStaffProperties = {
      'ÊñôÁêÜÈï∑': { status: 'Á§æÂì°', position: 'Head Chef', color: 'position-chef', startPeriod: { year: 2022, month: 4, day: 1 }, endPeriod: null },
      '‰∫ïÈñ¢': { status: 'Á§æÂì°', position: 'Chef', color: 'position-chef', startPeriod: { year: 2023, month: 6, day: 15 }, endPeriod: null },
      '‰∏éÂÑÄ': { status: 'Á§æÂì°', position: 'Server', color: 'position-server', startPeriod: { year: 2024, month: 1, day: 15 }, endPeriod: null },
      'Áî∞Ëæ∫': { status: 'Á§æÂì°', position: 'Server', color: 'position-server', startPeriod: { year: 2024, month: 2, day: 1 }, endPeriod: null },
      'Âè§Ëó§': { status: 'Á§æÂì°', position: 'Host', color: 'position-host', startPeriod: { year: 2020, month: 8, day: 1 }, endPeriod: null },
      'Â∞èÊ±†': { status: 'Á§æÂì°', position: 'Server', color: 'position-server', startPeriod: { year: 2024, month: 3, day: 1 }, endPeriod: null },
      'Â≤∏': { status: 'Á§æÂì°', position: 'Prep', color: 'position-prep', startPeriod: { year: 2023, month: 5, day: 1 }, endPeriod: null },
      '„Ç´„Éû„É´': { status: 'Á§æÂì°', position: 'Server', color: 'position-server', startPeriod: { year: 2024, month: 4, day: 1 }, endPeriod: null },
      'È´òÈáé': { status: 'Á§æÂì°', position: 'Prep', color: 'position-prep', startPeriod: { year: 2025, month: 4, day: 1 }, endPeriod: null },
      '‰∏≠Áî∞': { status: 'Á§æÂì°', position: 'Manager', color: 'position-manager', startPeriod: { year: 2018, month: 4, day: 1 }, endPeriod: null }
    };

    return staffList.map(staff => {
      const defaults = defaultStaffProperties[staff.name];
      if (defaults) {
        return {
          ...staff,
          status: defaults.status, // Always use defaults status
          position: staff.position || defaults.position,
          color: staff.color || defaults.color,
          startPeriod: staff.startPeriod || defaults.startPeriod,
          endPeriod: defaults.endPeriod // Always use defaults endPeriod
        };
      }
      // For new staff not in defaults, ensure they have basic properties
      // Use current period start date for new staff to ensure they appear in current period
      const currentPeriod = monthPeriods[currentMonthIndex] || monthPeriods[6]; // Fallback to July-August
      const defaultStart = {
        year: currentPeriod.start.getFullYear(),
        month: currentPeriod.start.getMonth() + 1,
        day: currentPeriod.start.getDate()
      };
      
      return {
        ...staff,
        status: staff.status || 'Ê¥æÈÅ£',
        position: staff.position || 'Server',
        color: staff.color || 'position-server',
        startPeriod: staff.startPeriod || defaultStart,
        endPeriod: staff.endPeriod
      };
    });
  };

  // Default staff members configuration
  const defaultStaffMembersArray = [
    { 
      id: '01934d2c-8a7b-7000-8000-1a2b3c4d5e6f', 
      name: 'ÊñôÁêÜÈï∑', 
      position: 'Head Chef', 
      color: 'position-chef',
      status: 'Á§æÂì°',
      startPeriod: { year: 2022, month: 4, day: 1 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7001-8001-2b3c4d5e6f7a', 
      name: '‰∫ïÈñ¢', 
      position: 'Chef', 
      color: 'position-chef',
      status: 'Á§æÂì°',
      startPeriod: { year: 2023, month: 6, day: 15 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7002-8002-3c4d5e6f7a8b', 
      name: '‰∏éÂÑÄ', 
      position: 'Server', 
      color: 'position-server',
      status: 'Á§æÂì°',
      startPeriod: { year: 2024, month: 1, day: 15 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7003-8003-4d5e6f7a8b9c', 
      name: 'Áî∞Ëæ∫', 
      position: 'Server', 
      color: 'position-server',
      status: 'Á§æÂì°',
      startPeriod: { year: 2024, month: 2, day: 1 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7004-8004-5e6f7a8b9c0d', 
      name: 'Âè§Ëó§', 
      position: 'Host', 
      color: 'position-host',
      status: 'Á§æÂì°',
      startPeriod: { year: 2020, month: 8, day: 1 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7005-8005-6f7a8b9c0d1e', 
      name: 'Â∞èÊ±†', 
      position: 'Server', 
      color: 'position-server',
      status: 'Á§æÂì°',
      startPeriod: { year: 2024, month: 3, day: 1 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7006-8006-7a8b9c0d1e2f', 
      name: 'Â≤∏', 
      position: 'Prep', 
      color: 'position-prep',
      status: 'Á§æÂì°',
      startPeriod: { year: 2023, month: 5, day: 1 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7007-8007-8b9c0d1e2f3a', 
      name: '„Ç´„Éû„É´', 
      position: 'Server', 
      color: 'position-server',
      status: 'Á§æÂì°',
      startPeriod: { year: 2024, month: 4, day: 1 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-7008-8008-9c0d1e2f3a4b', 
      name: 'È´òÈáé', 
      position: 'prep', 
      color: 'position-prep',
      status: 'Á§æÂì°',
      startPeriod: { year: 2025, month: 4, day: 1 },
      endPeriod: null
    },
    { 
      id: '01934d2c-8a7b-700a-800a-1e2f3a4b5c6d', 
      name: '‰∏≠Áî∞', 
      position: 'Manager', 
      color: 'position-manager',
      status: 'Á§æÂì°',
      startPeriod: { year: 2018, month: 4, day: 1 },
      endPeriod: null
    }
  ];

  // Staff members with Japanese names - dynamic list that can be edited (using UUIDv7)
  const [staffMembers, setStaffMembers] = useState(() => defaultStaffMembersArray);

  // Shift symbols
  const shiftSymbols = {
    early: { symbol: '‚ñ≥', label: 'Early Shift', color: 'text-blue-600' },
    normal: { symbol: 'Ôºç', label: 'Normal Shift', color: 'text-gray-600' },
    late: { symbol: '‚óá', label: 'Late Shift', color: 'text-purple-600' },
    special: { symbol: '‚óè', label: 'Special Shift', color: 'text-green-600' },
    medamayaki: { symbol: '‚óé', label: 'ÁõÆÁéâÁÑº„Åç', color: 'text-orange-600' },
    zensai: { symbol: '‚ñ£', label: 'ÂâçËèú', color: 'text-teal-600' },
    off: { symbol: '√ó', label: 'Day Off', color: 'text-red-600' },
    holiday: { symbol: '‚òÖ', label: 'Designated Holiday', color: 'text-yellow-600' },
    unavailable: { symbol: '‚äò', label: 'Unavailable', color: 'text-red-800' }
  };

  // Dropdown order: normal shift, day off, early shift, designated holiday, special shift
  const shiftDropdownOrder = ['normal', 'off', 'early', 'holiday', 'special'];
  
  // Get dropdown order based on column
  const getDropdownOrder = (columnIndex, staffName) => {
    // Special dropdown for ‰∏≠Áî∞ column with unavailable option (no late shift)
    if (staffName === '‰∏≠Áî∞') {
      return ['unavailable', 'special', 'off'];
    }
    
    // For other staff, check if they are Á§æÂì° to show late shift option
    const staff = staffMembers.find(s => s.name === staffName);
    const isÁ§æÂì° = staff?.status === 'Á§æÂì°';
    
    
    if (isÁ§æÂì°) {
      // Á§æÂì° staff get late shift + new options (ÁõÆÁéâÁÑº„Åç, ÂâçËèú)
      return ['normal', 'off', 'early', 'late', 'medamayaki', 'zensai', 'holiday'];
    } else {
      // Ê¥æÈÅ£ staff get standard options (no late shift, no special symbols)
      return ['normal', 'off', 'early', 'holiday'];
    }
  };

  // Dynamic dropdown positioning logic
  const getDropdownPosition = (date, columnIndex, rowIndex) => {
    const day = date.getDate();
    const month = date.getMonth() + 1; // getMonth() returns 0-11, so add 1
    
    // Check if date is between 18-20 (inclusive)
    if (day >= 18 && day <= 20) {
      // Display on right for columns 1-9, on left for columns 10-12
      if (columnIndex <= 9) {
        return 'right';
      } else {
        // For last columns, check specific rows
        if (rowIndex === 0 || rowIndex === 1) { // 1st and 2nd rows - use 0% positioning
          return 'left-elevated-top';
        }
        return 'left';
      }
    }
    
    // Check if it's the last column to avoid going off-screen
    if (columnIndex === getOrderedStaffMembers.length) {
      // For 1st and 2nd rows, use elevated top positioning
      if (rowIndex === 0 || rowIndex === 1) { // 1st and 2nd rows - use 0% positioning
        return 'left-elevated-top';
      }
      return 'left';
    }
    
    // Default positioning for other dates
    return 'center';
  };

  // Month periods configuration (21st to 20th of next month)
  const monthPeriods = [
    { start: new Date(2025, 0, 21), end: new Date(2025, 1, 20), label: '1Êúà„Éª2Êúà' }, // Jan-Feb
    { start: new Date(2025, 1, 21), end: new Date(2025, 2, 20), label: '2Êúà„Éª3Êúà' }, // Feb-Mar
    { start: new Date(2025, 2, 21), end: new Date(2025, 3, 20), label: '3Êúà„Éª4Êúà' }, // Mar-Apr
    { start: new Date(2025, 3, 21), end: new Date(2025, 4, 20), label: '4Êúà„Éª5Êúà' }, // Apr-May
    { start: new Date(2025, 4, 21), end: new Date(2025, 5, 20), label: '5Êúà„Éª6Êúà' }, // May-Jun
    { start: new Date(2025, 5, 21), end: new Date(2025, 6, 20), label: '6Êúà„Éª7Êúà' }, // Jun-Jul
    { start: new Date(2025, 6, 21), end: new Date(2025, 7, 20), label: '7Êúà„Éª8Êúà' }, // Jul-Aug (current)
  ];

  // Generate date range based on current month index
  const generateDateRange = (monthIndex) => {
    const period = monthPeriods[monthIndex];
    const dates = [];
    
    let currentDate = new Date(period.start);
    while (currentDate <= period.end) {
      dates.push(new Date(currentDate));
      currentDate = addDays(currentDate, 1);
    }
    
    return dates;
  };

  const dateRange = useMemo(() => generateDateRange(currentMonthIndex), [currentMonthIndex]);

  // Initialize schedule state based on current month period
  const initializeSchedule = (monthIndex = currentMonthIndex) => {
    const scheduleData = {};
    const staffIds = ['chef', 'iseki', 'yogi', 'tanabe', 'koto', 'koike', 'kishi', 'kamal', 'takano', 'yasui', 'nakata'];
    
    // Initialize each staff member
    staffIds.forEach(staffId => {
      scheduleData[staffId] = {};
    });
    
    // For all months, create completely blank schedule that user can fill
    const currentRange = generateDateRange(monthIndex);
    currentRange.forEach(date => {
      const dateKey = format(date, 'yyyy-MM-dd');
      staffIds.forEach(staffId => {
        // Leave completely blank - no default values
        scheduleData[staffId][dateKey] = '';
      });
    });
    
    return scheduleData;
  };

  // Local state - much simpler with React Query
  const [schedule, setSchedule] = useState(() => initializeSchedule(currentMonthIndex));
  const [editingCell, setEditingCell] = useState(null);
  const [exportFormat, setExportFormat] = useState('csv');
  const [showDropdown, setShowDropdown] = useState(null);
  const [customText, setCustomText] = useState('');
  const [showMonthPicker, setShowMonthPicker] = useState(false);
  const [editingColumn, setEditingColumn] = useState(null);
  const [editingSpecificColumn, setEditingSpecificColumn] = useState(null);
  const [editingColumnName, setEditingColumnName] = useState('');
  const [editingNames, setEditingNames] = useState({});
  const [justEnteredEditMode, setJustEnteredEditMode] = useState(false);
  const newColumnInputRef = useRef(null);
  
  // Helper function to get days in a month
  const getDaysInMonth = (year, month) => {
    return new Date(year, month, 0).getDate();
  };

  // Helper function to check if date is within staff work period
  const isDateWithinWorkPeriod = (date, staff) => {
    if (!staff.startPeriod) return true; // If no start period defined, assume always working
    
    const currentDate = new Date(date);
    
    // Check if before start date
    const startDate = new Date(
      staff.startPeriod.year, 
      staff.startPeriod.month - 1, 
      staff.startPeriod.day || 1
    );
    
    if (currentDate < startDate) {
      return false; // Before start date
    }
    
    // Check if after end date (only if end period is defined)
    if (staff.endPeriod) {
      const endDate = new Date(
        staff.endPeriod.year, 
        staff.endPeriod.month - 1, 
        staff.endPeriod.day || 1
      );
      
      if (currentDate > endDate) {
        return false; // After end date
      }
    }
    
    return true; // Within work period
  };

  // Function to sync updated staff data to database
  const syncUpdatedStaffToDatabase = async () => {
    try {
      // Force save current staff members to database
      await saveScheduleData({ 
        schedule_data: schedule, 
        staff_members: staffMembers 
      }, currentScheduleId);
    } catch (error) {
      // Silent error handling
    }
  };

  // Manual sync function to ensure all migrated data is in database
  const forceFullSync = async () => {
    try {
      const dataToSave = { 
        schedule_data: schedule, 
        staff_members: staffMembers 
      };
      await saveScheduleData(dataToSave, currentScheduleId);
      return true;
    } catch (error) {
      return false;
    }
  };



  // Helper function to check if staff is active during the current month period
  const isStaffActiveInCurrentPeriod = (staff) => {
    // Defensive checks
    if (!staff) return false;
    if (!staff.startPeriod) return true; // If no start period defined, assume always working
    if (!dateRange || dateRange.length === 0) return true; // If dateRange not ready, show all staff
    
    // Get the first and last dates of current month period
    const firstDate = dateRange[0];
    const lastDate = dateRange[dateRange.length - 1];
    
    // Validate dates
    if (!firstDate || !lastDate) return true;
    
    const startDate = new Date(
      staff.startPeriod.year, 
      staff.startPeriod.month - 1, 
      staff.startPeriod.day || 1
    );
    
    // Check if staff starts after the current period ends
    if (startDate > lastDate) {
      return false; // Starts after current period
    }
    
    // Check if staff ended before the current period starts
    if (staff.endPeriod) {
      const endDate = new Date(
        staff.endPeriod.year, 
        staff.endPeriod.month - 1, 
        staff.endPeriod.day || 1
      );
      
      if (endDate < firstDate) {
        return false; // Ended before current period
      }
    }
    
    return true; // Active during current period
  };

  // Helper function to check if date matches staff start/end period
  const getDateLabel = (date, staff) => {
    if (!staff.startPeriod && !staff.endPeriod) return null;
    
    const dateKey = format(date, 'yyyy-MM-dd');
    
    // Check start period
    if (staff.startPeriod) {
      const startDate = new Date(
        staff.startPeriod.year, 
        staff.startPeriod.month - 1, 
        staff.startPeriod.day || 1
      );
      const startDateKey = format(startDate, 'yyyy-MM-dd');
      if (dateKey === startDateKey) {
        return 'START';
      }
    }
    
    // Check end period
    if (staff.endPeriod) {
      const endDate = new Date(
        staff.endPeriod.year, 
        staff.endPeriod.month - 1, 
        staff.endPeriod.day || 1
      );
      const endDateKey = format(endDate, 'yyyy-MM-dd');
      if (dateKey === endDateKey) {
        return 'END';
      }
    }
    
    return null;
  };
  
  // Staff Edit Modal states
  const [showStaffEditModal, setShowStaffEditModal] = useState(false);
  const [selectedStaffForEdit, setSelectedStaffForEdit] = useState(null);
  const [isAddingNewStaff, setIsAddingNewStaff] = useState(false);
  const [editingStaffData, setEditingStaffData] = useState({
    name: '',
    position: '',
    status: 'Á§æÂì°',
    startPeriod: { 
      year: monthPeriods[currentMonthIndex].start.getFullYear(), 
      month: monthPeriods[currentMonthIndex].start.getMonth() + 1, 
      day: monthPeriods[currentMonthIndex].start.getDate() 
    },
    endPeriod: { year: new Date().getFullYear() + 1, month: new Date().getMonth() + 1, day: 1 }
  });
  
  
  // Initialize editing names when entering edit-name-mode
  useEffect(() => {
    if (editingColumn === 'edit-name-mode') {
      const initialNames = {};
      staffMembers.forEach(staff => {
        initialNames[staff.id] = staff.name;
      });
      setEditingNames(initialNames);
    }
  }, [editingColumn, staffMembers]);

  // Focus on new column input when in edit mode
  useEffect(() => {
    if (editingSpecificColumn && newColumnInputRef.current) {
      setTimeout(() => {
        try {
          if (newColumnInputRef.current && newColumnInputRef.current.focus) {
            newColumnInputRef.current.focus();
            if (newColumnInputRef.current.select) {
              newColumnInputRef.current.select();
            }
          }
        } catch (error) {
          // Silently handle focus errors
        }
      }, 150);
    }
  }, [editingSpecificColumn, staffMembers.length]);
  
  // Update schedule when month changes - preserve existing data
  useEffect(() => {
    // Save current schedule data AND staff members before switching
    if (schedule) {
      const updatedSchedulesByMonth = {
        ...schedulesByMonth,
        [currentMonthIndex]: schedule
      };
      setSchedulesByMonth(updatedSchedulesByMonth);
      saveToLocalStorage(STORAGE_KEYS.SCHEDULES_BY_MONTH, updatedSchedulesByMonth);
    }
    if (staffMembers && staffMembers.length > 0) {
      const updatedStaffByMonth = {
        ...staffMembersByMonth,
        [currentMonthIndex]: staffMembers
      };
      setStaffMembersByMonth(updatedStaffByMonth);
      saveToLocalStorage(STORAGE_KEYS.STAFF_BY_MONTH, updatedStaffByMonth);
    }
    
    // Load schedule for new month (either from cache, database data, or initialize new)
    const savedSchedule = schedulesByMonth[currentMonthIndex];
    const savedStaffMembers = staffMembersByMonth[currentMonthIndex];
    
    if (savedSchedule) {
      setSchedule(savedSchedule);
    } else {
      // Check if we have database data that matches current month dates
      if (supabaseScheduleData && supabaseScheduleData.schedule_data) {
        const { _staff_members, ...actualScheduleData } = supabaseScheduleData.schedule_data;
        
        // Check if database data has dates that match current month range
        const currentDateRange = generateDateRange(currentMonthIndex);
        const hasMatchingDates = currentDateRange.some(date => {
          const dateKey = format(date, 'yyyy-MM-dd');
          return Object.keys(actualScheduleData).some(staffId => 
            actualScheduleData[staffId] && actualScheduleData[staffId][dateKey]
          );
        });
        
        if (hasMatchingDates) {
          setSchedule(actualScheduleData);
        } else {
          setSchedule(initializeSchedule(currentMonthIndex));
        }
      } else {
        setSchedule(initializeSchedule(currentMonthIndex));
      }
    }
    
    if (savedStaffMembers) {
      setStaffMembers(migrateStaffMembers(savedStaffMembers));
    } else {
      // If no saved staff members for this month, use the default staff members
      // This ensures staff members are always available when switching months
      setStaffMembers(defaultStaffMembersArray);
    }
  }, [currentMonthIndex]);
  
  // Auto-save with debouncing
  const autoSaveTimeoutRef = useRef(null);
  
  // localStorage keys for fallback persistence
  const STORAGE_KEYS = {
    SCHEDULE: 'shift_schedule_data',
    STAFF_MEMBERS: 'shift_staff_members',
    SCHEDULES_BY_MONTH: 'shift_schedules_by_month',
    STAFF_BY_MONTH: 'shift_staff_by_month'
  };

  // localStorage utility functions
  const saveToLocalStorage = (key, data) => {
    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (error) {
      // Silent save to localStorage error
    }
  };

  const loadFromLocalStorage = (key) => {
    try {
      const data = localStorage.getItem(key);
      if (data) {
        const parsed = JSON.parse(data);
        return parsed;
      }
    } catch (error) {
      // Silent load from localStorage error
    }
    return null;
  };

  // Initialize data from localStorage on first load
  useEffect(() => {
    
    // Load from localStorage as fallback
    const savedSchedule = loadFromLocalStorage(STORAGE_KEYS.SCHEDULE);
    const savedStaffMembers = loadFromLocalStorage(STORAGE_KEYS.STAFF_MEMBERS);
    const savedSchedulesByMonth = loadFromLocalStorage(STORAGE_KEYS.SCHEDULES_BY_MONTH);
    const savedStaffByMonth = loadFromLocalStorage(STORAGE_KEYS.STAFF_BY_MONTH);
    
    if (savedSchedule) {
      setSchedule(savedSchedule);
    }
    if (savedStaffMembers) {
      setStaffMembers(migrateStaffMembers(savedStaffMembers));
    }
    if (savedSchedulesByMonth) {
      setSchedulesByMonth(savedSchedulesByMonth);
    }
    if (savedStaffByMonth) {
      setStaffMembersByMonth(savedStaffByMonth);
    }
  }, []); // Only run once on mount


  // Load schedule data from React Query - automatic with caching
  useEffect(() => {
    if (supabaseScheduleData && supabaseScheduleData.schedule_data) {
      const scheduleDataFromDb = supabaseScheduleData.schedule_data;
      
      // Extract staff members from the special _staff_members key
      if (scheduleDataFromDb._staff_members) {
        const migratedStaffMembers = migrateStaffMembers(scheduleDataFromDb._staff_members);
        
        // Only update if staff members are actually different (prevent infinite loop)
        const currentStaffIds = staffMembers.map(s => s.id).sort().join(',');
        const newStaffIds = migratedStaffMembers.map(s => s.id).sort().join(',');
        const staffStructureChanged = currentStaffIds !== newStaffIds;
        
        // Check if any staff member properties have changed
        const staffPropertiesChanged = migratedStaffMembers.some(migrated => {
          const current = staffMembers.find(s => s.id === migrated.id);
          return !current || 
            current.status !== migrated.status ||
            JSON.stringify(current.endPeriod) !== JSON.stringify(migrated.endPeriod) ||
            current.name !== migrated.name;
        });
        
        // Only update if there are actual changes
        if (staffStructureChanged || staffPropertiesChanged) {
          setStaffMembers(migratedStaffMembers);
          // Also store in month cache and localStorage
          setStaffMembersByMonth(prev => ({
            ...prev,
            [currentMonthIndex]: migratedStaffMembers
          }));
          saveToLocalStorage(STORAGE_KEYS.STAFF_MEMBERS, migratedStaffMembers);
          
          // Schedule a delayed sync to database to avoid infinite loop
          setTimeout(() => {
            if (schedule && !isSaving) {
              syncUpdatedStaffToDatabase();
            }
          }, 3000);
        }
      }
      
      // Remove the _staff_members key from schedule data before setting
      const { _staff_members, ...actualScheduleData } = scheduleDataFromDb;
      
      // Only update schedule if it's actually different
      const currentScheduleStr = JSON.stringify(schedule);
      const newScheduleStr = JSON.stringify(actualScheduleData);
      
      if (currentScheduleStr !== newScheduleStr) {
        setSchedule(actualScheduleData);
        saveToLocalStorage(STORAGE_KEYS.SCHEDULE, actualScheduleData);
      }
      
      // Only update schedule ID if it's different
      if (currentScheduleId !== supabaseScheduleData.id) {
        setCurrentScheduleId(supabaseScheduleData.id);
      }
    }
  }, [supabaseScheduleData?.id, supabaseScheduleData?.updated_at, currentMonthIndex]);

  // React Query Auto-save with debouncing - much simpler!
  const scheduleAutoSave = useCallback((newScheduleData, newStaffMembers = null) => {
    // Clear existing timer
    if (autoSaveTimeoutRef.current) {
      clearTimeout(autoSaveTimeoutRef.current);
    }

    // Immediately save to localStorage as backup
    const currentStaffMembers = newStaffMembers || staffMembers;
    saveToLocalStorage(STORAGE_KEYS.SCHEDULE, newScheduleData);
    saveToLocalStorage(STORAGE_KEYS.STAFF_MEMBERS, currentStaffMembers);
    saveToLocalStorage(STORAGE_KEYS.SCHEDULES_BY_MONTH, schedulesByMonth);
    saveToLocalStorage(STORAGE_KEYS.STAFF_BY_MONTH, staffMembersByMonth);

    // Set timer for auto-save after inactivity
    autoSaveTimeoutRef.current = setTimeout(async () => {
      try {
        // Save both schedule data and staff members
        
        // Save schedule data and staff members separately
        const dataToSave = { 
          schedule_data: newScheduleData, 
          staff_members: currentStaffMembers 
        };
        
        await autoSave(dataToSave, currentScheduleId, 0); // No delay, immediate save
      } catch (error) {
        // Silent auto-save error
        // Don't show alert for auto-save errors as they're automatic
      }
    }, 2000); // 2 seconds of inactivity
  }, [autoSave, currentScheduleId, staffMembers, schedulesByMonth, staffMembersByMonth]);

  // Cleanup timer on unmount
  useEffect(() => {
    return () => {
      if (autoSaveTimeoutRef.current) {
        clearTimeout(autoSaveTimeoutRef.current);
      }
    };
  }, []);


  // Handle shift change with React Query optimistic updates
  const handleShiftChange = (staffId, dateKey, newShift) => {
    const newSchedule = {
      ...schedule,
      [staffId]: {
        ...schedule[staffId],
        [dateKey]: newShift
      }
    };
    
    // Update UI immediately - React Query handles optimistic updates
    setSchedule(newSchedule);
    setEditingCell(null);
    
    // Also update the cached schedule for current month
    setSchedulesByMonth(prev => ({
      ...prev,
      [currentMonthIndex]: newSchedule
    }));
    
    // Use React Query auto-save - seamless, no refresh
    scheduleAutoSave(newSchedule);
  };

  // Handle cell click for editing
  const handleCellClick = (staffId, dateKey) => {
    const cellId = `${staffId}-${dateKey}`;
    setShowDropdown(showDropdown === cellId ? null : cellId);
    setEditingCell(null);
  };

  // Handle shift selection from dropdown
  const handleShiftSelect = (staffId, dateKey, newShift) => {
    handleShiftChange(staffId, dateKey, newShift);
    setShowDropdown(null);
  };

  // Simple status display with React Query
  const getSyncStatusDisplay = () => {
    if (!isConnected) {
      return {
        color: 'red',
        text: 'Disconnected',
        icon: 'üî¥'
      };
    }
    
    if (isSaving) {
      return {
        color: 'blue',
        text: 'Saving...',
        icon: 'üîÑ'
      };
    }
    
    if (error) {
      return {
        color: 'red',
        text: 'Error',
        icon: '‚ùå'
      };
    }
    
    return {
      color: 'green',
      text: 'Synced',
      icon: '‚úÖ'
    };
  };

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      try {
        // Safely check event target exists
        if (!event || !event.target) return;
        
        // Auto save when clicking outside any dropdown or cell
        if (showDropdown && event.target.closest && !event.target.closest('.shift-dropdown')) {
          // Auto save any pending changes before closing dropdown
          if (schedule) {
            scheduleAutoSave(schedule, staffMembers);
          }
          setShowDropdown(null);
        }
        
        if (showMonthPicker && event.target.closest && !event.target.closest('.month-picker')) {
          setShowMonthPicker(false);
        }
        
        // Exit edit mode when clicking outside table header - auto save changes
        if ((editingColumn === 'delete-mode' || editingColumn === 'edit-name-mode' || editingSpecificColumn) && 
            event.target.closest && 
            !event.target.closest('th') && 
            !event.target.closest('button') && 
            !justEnteredEditMode) {
          // Auto save any pending changes before exiting
          if (schedule) {
            scheduleAutoSave(schedule, staffMembers);
          }
          if (editingColumn === 'edit-name-mode') {
            // Save all changes before exiting
            Object.keys(editingNames).forEach(staffId => {
              const newName = editingNames[staffId];
              if (newName && newName.trim()) {
                editColumnName(staffId, newName.trim());
              }
            });
            setEditingColumn(null);
          } else {
            exitEditMode();
          }
        }
      } catch (error) {
        // Reset states on error to prevent stuck modals
        setShowDropdown(null);
        setShowMonthPicker(false);
      }
    };

    try {
      document.addEventListener('click', handleClickOutside);
    } catch (error) {
      // Silently handle click listener errors
    }
    
    return () => {
      try {
        document.removeEventListener('click', handleClickOutside);
      } catch (error) {
        // Silently handle click listener errors
      }
    };
  }, [showDropdown, showMonthPicker, editingColumn, editingSpecificColumn]);

  // Remove tab management - using single page layout

  // Handle key press for quick editing
  const handleKeyPress = (e, staffId, dateKey) => {
    const currentShift = schedule[staffId][dateKey];
    let newShift = currentShift;

    switch (e.key) {
      case '1':
      case 'e':
      case 'E':
        newShift = 'early';
        break;
      case '2':
      case 'n':
      case 'N':
        newShift = 'normal';
        break;
      case '3':
      case 'o':
      case 'O':
      case 'x':
      case 'X':
        newShift = 'off';
        break;
      case ' ':
        // Cycle through shifts
        const shifts = ['early', 'normal', 'off'];
        const currentIndex = shifts.indexOf(currentShift);
        newShift = shifts[(currentIndex + 1) % shifts.length];
        break;
    }

    if (newShift !== currentShift) {
      handleShiftChange(staffId, dateKey, newShift);
    }
  };

  // Calculate vacation days for staff
  const calculateVacationDays = (staffId) => {
    let vacationDays = 0;
    dateRange.forEach(date => {
      const dateKey = format(date, 'yyyy-MM-dd');
      // Safe access to schedule data
      const staffSchedule = schedule[staffId];
      const shift = staffSchedule && staffSchedule[dateKey] ? staffSchedule[dateKey] : '';
      
      if (shift === 'early') {
        vacationDays += 0.5; // ‚ñ≥ = 0.5 days
      } else if (shift === 'off' || shift === 'unavailable' || shift === 'holiday') {
        vacationDays += 1; // √ó, ‚äò, and ‚òÖ = 1 day
      }
      // ‚óã, ‚óá, ‚óé, ‚ñ£ = 0 days (no vacation)
      // medamayaki and zensai don't count as vacation days
    });
    return vacationDays;
  };

  // Get comprehensive statistics
  const getStatistics = () => {
    const stats = {
      totalShifts: { early: 0, normal: 0, late: 0, off: 0 },
      staffStats: {},
      vacationTotals: {}
    };

    // Only calculate stats for active staff members
    const activeStaff = staffMembers.filter(staff => isStaffActiveInCurrentPeriod(staff));
    
    activeStaff.forEach(staff => {
      stats.staffStats[staff.id] = {
        name: staff.name,
        position: staff.position,
        early: 0,
        normal: 0,
        late: 0,
        off: 0,
        workDays: 0,
        vacationDays: 0
      };

      dateRange.forEach(date => {
        const dateKey = format(date, 'yyyy-MM-dd');
        // Safe access to schedule data
        const staffSchedule = schedule[staff.id];
        const shift = staffSchedule && staffSchedule[dateKey] ? staffSchedule[dateKey] : '';
        
        // Count shifts with mapping: special->normal, unavailable->off, holiday->off
        // Exclude medamayaki and zensai from all statistics
        let countedShift = shift;
        if (shift === 'special') {
          countedShift = 'normal';
        } else if (shift === 'unavailable' || shift === 'holiday') {
          countedShift = 'off';
        } else if (shift === 'late') {
          countedShift = 'late'; // Keep late shift as separate count
        } else if (shift === 'medamayaki' || shift === 'zensai') {
          // Skip counting these special symbols
          return;
        }
        
        // Only count known shift types
        if (countedShift === 'early' || countedShift === 'normal' || countedShift === 'late' || countedShift === 'off') {
          stats.totalShifts[countedShift]++;
          stats.staffStats[staff.id][countedShift]++;
        }
        
        // Count work days (exclude off, unavailable, holiday, medamayaki, zensai)
        if (shift !== 'off' && shift !== 'unavailable' && shift !== 'holiday' && 
            shift !== 'medamayaki' && shift !== 'zensai') {
          stats.staffStats[staff.id].workDays++;
        }
      });

      stats.staffStats[staff.id].vacationDays = calculateVacationDays(staff.id);
      stats.vacationTotals[staff.id] = stats.staffStats[staff.id].vacationDays;
    });

    return stats;
  };

  const statistics = getStatistics();

  // Reset schedule
  const resetSchedule = () => {
    setSchedule(initializeSchedule());
  };

  // Function to delete only current month period data
  const deleteCurrentPeriodData = async () => {
    const currentPeriodLabel = monthPeriods[currentMonthIndex].label;
    const confirmed = window.confirm(
      `‚ö†Ô∏è Delete ${currentPeriodLabel} Period Data\n\n` +
      'This will delete:\n' +
      `‚Ä¢ Schedule data for ${currentPeriodLabel} period\n` +
      `‚Ä¢ localStorage cache for this period\n\n` +
      'Other period data will remain intact.\n\n' +
      'Are you sure you want to proceed?'
    );
    
    if (!confirmed) return;
    
    try {
      // 1. Clear current period from localStorage
      const currentSchedulesKey = `${STORAGE_KEYS.SCHEDULES_BY_MONTH}`;
      const currentStaffKey = `${STORAGE_KEYS.STAFF_BY_MONTH}`;
      
      // Get existing data
      const existingSchedules = getFromLocalStorage(currentSchedulesKey, {});
      const existingStaff = getFromLocalStorage(currentStaffKey, {});
      
      // Remove current month data
      delete existingSchedules[currentMonthIndex];
      delete existingStaff[currentMonthIndex];
      
      // Save back to localStorage
      saveToLocalStorage(currentSchedulesKey, existingSchedules);
      saveToLocalStorage(currentStaffKey, existingStaff);
      
      // 2. Delete current schedule in database if it exists
      if (currentScheduleId) {
        try {
          await deleteScheduleData(currentScheduleId);
        } catch (dbError) {
          console.warn('Failed to delete from database:', dbError);
        }
      }
      
      // 3. Reset current period state
      setSchedule(initializeSchedule(currentMonthIndex));
      setStaffMembers(defaultStaffMembersArray);
      setCurrentScheduleId(null);
      setEditingCell(null);
      
      // 4. Update month caches
      setSchedulesByMonth(existingSchedules);
      setStaffMembersByMonth(existingStaff);
      
      alert(`${currentPeriodLabel} period data has been deleted successfully.`);
      
    } catch (error) {
      console.error('Error deleting current period data:', error);
      alert('Error occurred while deleting period data. Please try again.');
    }
  };

  // Function to order staff members with ‰∏≠Áî∞ always at the end, filtering out inactive staff
  const getOrderedStaffMembers = useMemo(() => {
    try {
      // Defensive check
      if (!staffMembers || !Array.isArray(staffMembers) || staffMembers.length === 0) {
        return []; // Return empty array if no staff members
      }
      
      // First filter out staff who are not active in the current period
      const activeStaff = staffMembers.filter(staff => {
        try {
          return staff && isStaffActiveInCurrentPeriod(staff);
        } catch (error) {
          // If there's an error checking activity, include the staff member
          console.warn('Error checking staff activity:', error, staff);
          return true;
        }
      });
      
      // If no active staff found but we have staff members, return all staff (fallback)
      if (activeStaff.length === 0 && staffMembers.length > 0) {
        const nakataStaff = staffMembers.find(staff => staff && staff.name === '‰∏≠Áî∞');
        const otherStaff = staffMembers.filter(staff => staff && staff.name !== '‰∏≠Áî∞');
        return nakataStaff ? [...otherStaff, nakataStaff] : staffMembers;
      }
      
      const nakataStaff = activeStaff.find(staff => staff && staff.name === '‰∏≠Áî∞');
      const otherStaff = activeStaff.filter(staff => staff && staff.name !== '‰∏≠Áî∞');
      return nakataStaff ? [...otherStaff, nakataStaff] : activeStaff;
    } catch (error) {
      console.error('Error in getOrderedStaffMembers:', error);
      return staffMembers || []; // Return original staff members or empty array
    }
  }, [staffMembers, dateRange]);

  // Column management functions
  const addNewColumn = () => {
    // Show add staff modal instead of immediately adding column
    setIsAddingNewStaff(true);
    setSelectedStaffForEdit(null); // Clear any existing staff selection
    setEditingStaffData({
      name: '',
      position: '',
      status: 'Á§æÂì°',
      startPeriod: { 
        year: monthPeriods[currentMonthIndex].start.getFullYear(), 
        month: monthPeriods[currentMonthIndex].start.getMonth() + 1, 
        day: monthPeriods[currentMonthIndex].start.getDate() 
      },
      endPeriod: null
    });
    setShowStaffEditModal(false); // Skip staff selection modal for add mode
  };

  // Function to actually create new staff after modal completion
  const createNewStaff = (staffData) => {
    const newStaffId = `01934d2c-8a7b-7${Date.now().toString(16).slice(-3)}-8${Math.random().toString(16).slice(2, 5)}-${Math.random().toString(16).slice(2, 14)}`;
    
    // Ensure new staff have a valid start period that allows them to appear in current period
    const currentPeriod = monthPeriods[currentMonthIndex];
    const defaultStartPeriod = {
      year: currentPeriod.start.getFullYear(),
      month: currentPeriod.start.getMonth() + 1,
      day: currentPeriod.start.getDate()
    };
    
    const newStaff = {
      id: newStaffId,
      name: staffData.name || 'Êñ∞„Åó„ÅÑ„Çπ„Çø„ÉÉ„Éï',
      position: staffData.position || 'Staff',
      color: 'position-server',
      status: staffData.status,
      startPeriod: staffData.startPeriod || defaultStartPeriod,
      endPeriod: staffData.endPeriod
    };
    
    const newStaffMembers = [...staffMembers, newStaff];
    
    // Add empty schedule data for new staff member
    const newSchedule = {
      ...schedule,
      [newStaffId]: {}
    };
    
    // Initialize all dates for the new staff member
    dateRange.forEach(date => {
      const dateKey = format(date, 'yyyy-MM-dd');
      newSchedule[newStaffId][dateKey] = ''; // Start with blank
    });
    
    // Batch all state updates together for immediate UI response
    React.startTransition(() => {
      setStaffMembers(newStaffMembers);
      setSchedule(newSchedule);
      setSchedulesByMonth(prev => ({
        ...prev,
        [currentMonthIndex]: newSchedule
      }));
      setStaffMembersByMonth(prev => ({
        ...prev,
        [currentMonthIndex]: newStaffMembers
      }));
    });
    
    // Close modal immediately for better UX
    setShowStaffEditModal(false);
    setIsAddingNewStaff(false);
    
    // Save to database asynchronously (don't block UI)
    setTimeout(() => {
      scheduleAutoSave(newSchedule, newStaffMembers);
    }, 0);
  };

  const editColumnName = (staffId, newName) => {
    const newStaffMembers = staffMembers.map(staff => 
      staff.id === staffId ? { ...staff, name: newName } : staff
    );
    
    // Use startTransition for immediate UI update
    React.startTransition(() => {
      setStaffMembers(newStaffMembers);
      setStaffMembersByMonth(prev => ({
        ...prev,
        [currentMonthIndex]: newStaffMembers
      }));
    });
    
    // Save changes to database asynchronously
    setTimeout(() => {
      scheduleAutoSave(schedule, newStaffMembers);
    }, 0);
  };

  const exitEditMode = () => {
    setEditingColumn(null);
    setEditingSpecificColumn(null);
    setEditingColumnName('');
  };

  const deleteColumn = (staffId) => {
    if (staffMembers.length <= 1) {
      alert('ÊúÄ‰Ωé1„Å§„ÅÆÂàó„ÅØÂøÖË¶Å„Åß„Åô„ÄÇ');
      return;
    }
    
    // Delete immediately without confirmation
    const newStaffMembers = staffMembers.filter(staff => staff.id !== staffId);
    
    // Remove from schedule data
    const newSchedule = { ...schedule };
    delete newSchedule[staffId];
    
    // Use startTransition for immediate UI update
    React.startTransition(() => {
      setStaffMembers(newStaffMembers);
      setSchedule(newSchedule);
      setSchedulesByMonth(prev => ({
        ...prev,
        [currentMonthIndex]: newSchedule
      }));
      setStaffMembersByMonth(prev => ({
        ...prev,
        [currentMonthIndex]: newStaffMembers
      }));
    });
    
    // Save changes to database asynchronously
    setTimeout(() => {
      scheduleAutoSave(newSchedule, newStaffMembers);
    }, 0);
    
    // Exit delete mode after deleting
    setEditingColumn(null);
  };

  // Manual save with React Query - seamless
  const saveScheduleManually = async () => {
    try {
      // Clear any pending auto-save
      if (autoSaveTimeoutRef.current) {
        clearTimeout(autoSaveTimeoutRef.current);
      }
      
      // Force immediate save - user explicitly requested it
      const dataToSave = { schedule_data: schedule, staff_members: staffMembers };
      const savedSchedule = await saveScheduleData(dataToSave, currentScheduleId);
      
      if (!currentScheduleId && savedSchedule) {
        setCurrentScheduleId(savedSchedule.id);
      }
      
      
    } catch (err) {
      const errorMessage = err?.message || err?.error?.message || String(err);
      alert(`‰øùÂ≠ò„Ç®„É©„Éº: ${errorMessage}`);
    }
  };

  // Export functions - Updated for vertical layout


  const exportToCSV = () => {
    const headers = ['Date / Êó•‰ªò', ...getOrderedStaffMembers.map(staff => staff?.name || 'Unknown')];
    const rows = [headers];

    dateRange.forEach(date => {
      const dateKey = format(date, 'yyyy-MM-dd');
      const row = [
        `${format(date, 'dd-MMM')} (${format(date, 'EEE', { locale: ja })})`,
        ...getOrderedStaffMembers.map(staff => {
          // Check if date is within work period
          if (!isDateWithinWorkPeriod(date, staff)) {
            return '-'; // Show dash for dates outside work period
          }
          const shift = schedule[staff.id]?.[dateKey] || '';
          return shift ? shiftSymbols[shift]?.symbol || '' : '';
        })
      ];
      rows.push(row);
    });

    try {
      const csvContent = rows.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `shift-schedule-${format(new Date(), 'yyyy-MM-dd')}.csv`;
      
      // Safely append and click
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Clean up blob URL
      URL.revokeObjectURL(link.href);
    } catch (error) {
      alert('CSV export failed. Please try again.');
    }
  };

  const exportToPrint = () => {
    const printContent = `
      <html>
        <head>
          <title>Shift Schedule - ${format(dateRange[0], 'yyyyÂπ¥MÊúàdÊó•')} ~ ${format(dateRange[dateRange.length - 1], 'yyyyÂπ¥MÊúàdÊó•')}</title>
          <style>
            body { font-family: 'Noto Sans JP', sans-serif; margin: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
            th { background-color: #dc2626; color: white; }
            .date-header { font-weight: bold; background-color: #fef2f2; }
            .early { background-color: #fef3c7; }
            .normal { background-color: #dcfce7; }
            .off { background-color: #f3f4f6; }
          </style>
        </head>
        <body>
          <h1>üç£ Japanese Restaurant Shift Schedule</h1>
          <p>ÊúüÈñì: ${format(dateRange[0], 'yyyyÂπ¥MÊúàdÊó•')} ~ ${format(dateRange[dateRange.length - 1], 'yyyyÂπ¥MÊúàdÊó•')}</p>
          <table>
            <thead>
              <tr>
                <th>Êó•‰ªò / Date</th>
                ${getOrderedStaffMembers.map(staff => `<th>${staff.name}<br><small>${staff.position}</small></th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${dateRange.map(date => {
                const dateKey = format(date, 'yyyy-MM-dd');
                return `
                  <tr>
                    <td class="date-header">${format(date, 'dd-MMM')}<br><small>${format(date, 'EEE', { locale: ja })}</small></td>
                    ${getOrderedStaffMembers.map(staff => {
                      // Check if date is within work period
                      if (!isDateWithinWorkPeriod(date, staff)) {
                        return '<td class="not-working">-</td>'; // Show dash for dates outside work period
                      }
                      const shift = schedule[staff.id]?.[dateKey] || '';
                      const symbol = shift ? shiftSymbols[shift]?.symbol || '' : '';
                      return `<td class="${shift}">${symbol}</td>`;
                    }).join('')}
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <div style="margin-top: 20px; font-size: 12px;">
            <p>‚ñ≥ = Early Shift (10:00-18:00) | ‚óã = Normal Shift (11:00-20:00) | ‚óá = Late Shift (15:00-23:00) | √ó = Off Day | ‚äò = Unavailable</p>
          </div>
        </body>
      </html>
    `;

    try {
      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
      } else {
        // Fallback if popup blocked
        const blob = new Blob([printContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `shift-schedule-${format(new Date(), 'yyyy-MM-dd')}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
    } catch (error) {
      alert('Print failed. Please try again.');
    }
  };


  // Show loading state
  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="flex items-center gap-3">
          <div className="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
          <span className="text-gray-600">Loading schedule...</span>
        </div>
      </div>
    );
  }

  return (
    <>
    <div className="shift-schedule-editor">
      {/* Error Display */}
      {error && clearError && (
        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <div className="w-4 h-4 bg-red-500 rounded-full mr-3"></div>
              <span className="text-red-700 font-medium">Database Error:</span>
            </div>
            <button
              onClick={clearError}
              className="text-red-500 hover:text-red-700"
            >
              √ó
            </button>
          </div>
          <p className="text-red-600 mt-2">{
            error?.message || 
            error?.error?.message || 
            (typeof error === 'string' ? error : JSON.stringify(error, null, 2))
          }</p>
        </div>
      )}
      
      {/* Unified Navigation Bar */}
      <div className="w-4/5 mx-auto flex items-center justify-between mb-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
        {/* Left Side - Month Navigation and Action Icons */}
        <div className="flex items-center gap-2">
          <button
            onClick={() => setCurrentMonthIndex(Math.max(0, currentMonthIndex - 1))}
            disabled={currentMonthIndex === 0}
            className={`flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white transition-colors ${
              currentMonthIndex === 0
                ? 'cursor-not-allowed'
                : 'hover:border-gray-400'
            }`}
            title="Previous month"
          >
            <ChevronLeft size={16} className={currentMonthIndex === 0 ? 'text-gray-400' : 'text-gray-600 hover:text-gray-800'} />
          </button>
          
          <div className="relative month-picker">
            <button
              onClick={() => setShowMonthPicker(!showMonthPicker)}
              className="flex items-center px-4 py-2 h-10 text-sm font-medium bg-white rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer pr-8 pl-10 min-w-[120px]"
            >
              <Calendar size={16} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500" />
              <span className="font-bold text-gray-800">
                {monthPeriods[currentMonthIndex].label}
              </span>
              <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
                <svg className={`w-4 h-4 text-gray-500 transition-transform ${showMonthPicker ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </button>
            
            {/* Month Picker Grid */}
            {showMonthPicker && (
              <div className="absolute top-full left-1/2 transform -translate-x-1/2 mt-1 w-80 bg-white rounded-lg border border-gray-300 shadow-lg z-[1000] p-4">
                <div className="grid grid-cols-2 gap-2">
                  {monthPeriods.map((period, index) => (
                    <button
                      key={index}
                      onClick={() => {
                        setCurrentMonthIndex(index);
                        setShowMonthPicker(false);
                      }}
                      className={`p-3 text-sm font-medium rounded-lg border transition-colors ${
                        currentMonthIndex === index
                          ? 'bg-blue-500 text-white border-blue-500'
                          : 'bg-gray-50 text-gray-700 border-gray-200 hover:bg-blue-50 hover:border-blue-300'
                      }`}
                    >
                      <div className="text-center">
                        <div className="font-bold">{period.label}</div>
                        <div className="text-xs opacity-75 mt-1">
                          {format(period.start, 'MMM dd')} - {format(period.end, 'MMM dd')}
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
          
          <button
            onClick={() => setCurrentMonthIndex(Math.min(monthPeriods.length - 1, currentMonthIndex + 1))}
            disabled={currentMonthIndex === monthPeriods.length - 1}
            className={`flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white transition-colors ${
              currentMonthIndex === monthPeriods.length - 1
                ? 'cursor-not-allowed'
                : 'hover:border-gray-400'
            }`}
            title="Next month"
          >
            <ChevronRight size={16} className={currentMonthIndex === monthPeriods.length - 1 ? 'text-gray-400' : 'text-gray-600 hover:text-gray-800'} />
          </button>
          
          <div className="w-px h-6 bg-gray-300 mx-1"></div>
          
          {/* Toggle Fullscreen Button */}
          <button 
            onClick={() => {
              // TODO: Implement fullscreen toggle functionality
            }}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="Toggle Fullscreen"
          >
            <Maximize size={16} className="text-indigo-600 hover:text-indigo-700" />
          </button>
          
          {/* Force Sync Button */}
          <button 
            onClick={async () => {
              const success = await forceFullSync();
              if (success) {
                alert('‚úÖ Data synced to database successfully!');
              } else {
                alert('‚ùå Failed to sync data to database.');
              }
            }}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-green-300 bg-green-50 hover:bg-green-100 hover:border-green-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200"
            title="Force sync all data to database"
            disabled={isSaving}
          >
            <RefreshCw size={16} className={`${isSaving ? 'animate-spin text-gray-400' : 'text-green-600 hover:text-green-700'}`} />
          </button>


          {/* Delete Current Period Button */}
          <button 
            onClick={deleteCurrentPeriodData}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-orange-300 bg-orange-50 hover:bg-orange-100 hover:border-orange-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all duration-200"
            title={`Delete ${monthPeriods[currentMonthIndex].label} period data (other periods will remain intact)`}
            disabled={isSaving}
          >
            <Trash2 size={16} className="text-orange-600 hover:text-orange-700" />
          </button>
          
          {/* AI Assistant Button */}
          <button 
            onClick={() => {
              // TODO: Implement AI functionality
            }}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="AI Assistant"
          >
            <Sparkles size={16} className="text-violet-600 hover:text-violet-700" />
          </button>
          
          {/* Add Table Button */}
          <button 
            onClick={() => {
              // TODO: Implement add table functionality
            }}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="Add Table"
          >
            <TableProperties size={16} className="text-teal-600 hover:text-teal-700" />
          </button>
          
          {/* Add User Button */}
          <button
            onClick={addNewColumn}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="Add User"
          >
            <UserPlus size={16} className="text-green-600 hover:text-green-700" />
          </button>
          
          {/* Edit Staff Button */}
          <button
            onClick={() => {
              setShowStaffEditModal(true);
            }}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="Edit Staff"
          >
            <Edit size={16} className="text-purple-600 hover:text-purple-700" />
          </button>
          
          {/* Delete Columns Button */}
          <button
            onClick={() => {
              setEditingColumn('delete-mode');
            }}
            className={`flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border transition-all duration-200 ${
              editingColumn === 'delete-mode'
                ? 'border-red-300 bg-red-50 text-red-700 hover:bg-red-100'
                : 'border-gray-300 bg-white hover:border-gray-400'
            }`}
            title="Delete Columns"
          >
            <X size={16} className={editingColumn === 'delete-mode' ? 'text-red-600' : 'text-red-600 hover:text-red-700'} />
          </button>
          
          {/* Reset Button */}
          <button 
            onClick={resetSchedule}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="Reset Schedule"
          >
            <RotateCcw size={16} className="text-red-600 hover:text-red-700" />
          </button>

          {/* Download Button */}
          <button 
            onClick={exportToCSV}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="Download CSV"
          >
            <Download size={16} className="text-green-600 hover:text-green-700" />
          </button>
          
          {/* Print Button */}
          <button 
            onClick={exportToPrint}
            className="flex items-center px-3 py-2 h-10 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200"
            title="Print"
          >
            <Printer size={16} className="text-blue-600 hover:text-blue-700" />
          </button>
        </div>

        {/* Right Side - Status Indicator */}
        <div className="flex items-center gap-3">
          {/* Simple Saving Indicator */}
          {isSaving && (
            <div className="flex items-center gap-1">
              <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
            </div>
          )}
          
          {/* Exit Edit Mode Button - only show when in edit mode */}
          {editingColumn && (
            <button
              onClick={() => {
                if (editingColumn === 'edit-name-mode') {
                  // Save all changes before exiting
                  Object.keys(editingNames).forEach(staffId => {
                    const newName = editingNames[staffId];
                    if (newName && newName.trim()) {
                      editColumnName(staffId, newName.trim());
                    }
                  });
                }
                setEditingColumn(null);
              }}
              className="flex items-center px-4 py-2 h-10 text-sm font-medium rounded-lg border border-blue-300 text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 whitespace-nowrap"
            >
              <span>ÂÆå‰∫Ü</span>
            </button>
          )}
        </div>
      </div>

      
      
      {/* Schedule Table */}
      <div className="table-container w-4/5 mx-auto overflow-auto border border-gray-200 rounded-lg shadow-sm mb-6" style={{ maxHeight: 'calc(100vh - 110px)' }}>
        <table className="shift-table w-full text-sm" style={{ minWidth: `${60 + (staffMembers.length * 40)}px` }}>
          {/* Sticky Header Row: Staff Names as Column Headers */}
          <thead>
            <tr>
              <th className="bg-gray-600 text-white min-w-[60px] border-r-2 border-gray-400 sticky left-0" style={{ zIndex: 400 }}>
                <div className="flex items-center justify-center gap-1 py-0.5">
                  <Calendar size={12} />
                  <span className="font-bold text-xs">Êó•‰ªò / Date</span>
                </div>
              </th>
              {/* Staff Members as Column Headers - Sticky Top */}
              {getOrderedStaffMembers.map(staff => staff && (
                <th key={staff.id || 'unknown'} className="min-w-[40px] bg-gray-600 text-white border-r border-gray-400 relative">
                  <div className="text-center py-0.5">
                    {editingSpecificColumn === staff.id || editingColumn === 'edit-name-mode' ? (
                      <div className="font-bold japanese-text text-xs flex items-center justify-center gap-1">
                        <input
                          ref={editingSpecificColumn === staff.id ? newColumnInputRef : null}
                          type="text"
                          value={editingColumn === 'edit-name-mode' ? (editingNames[staff.id] !== undefined ? editingNames[staff.id] : staff.name) : editingColumnName}
                          onChange={(e) => {
                            if (editingColumn === 'edit-name-mode') {
                              const newValue = e.target.value;
                              setEditingNames(prev => ({
                                ...prev,
                                [staff.id]: newValue
                              }));
                            } else {
                              setEditingColumnName(e.target.value);
                            }
                          }}
                          onBlur={() => {
                            if (editingColumn === 'edit-name-mode') {
                              // Save current field and exit edit mode
                              const newName = editingNames[staff.id];
                              if (newName !== undefined) {
                                editColumnName(staff.id, newName.trim());
                              }
                              setEditingColumn(null);
                            } else {
                              if (editingColumnName.trim()) {
                                editColumnName(staff.id, editingColumnName.trim());
                              }
                              exitEditMode();
                            }
                          }}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') {
                              if (editingColumn === 'edit-name-mode') {
                                // Save current field and exit edit mode on Enter
                                const newName = editingNames[staff.id];
                                if (newName !== undefined) {
                                  editColumnName(staff.id, newName.trim());
                                }
                                setEditingColumn(null);
                              } else {
                                if (editingColumnName.trim()) {
                                  editColumnName(staff.id, editingColumnName.trim());
                                }
                                exitEditMode();
                              }
                            }
                          }}
                          className="w-full bg-white text-gray-900 text-xs font-bold text-center border-none outline-none rounded px-1"
                          style={{ minWidth: '60px' }}
                        />
                      </div>
                    ) : (
                      <div className="font-bold japanese-text text-xs flex items-center justify-center gap-1">
                        <span 
                          onClick={() => {
                            if (editingColumn !== 'delete-mode') {
                              // Direct edit staff functionality
                              setSelectedStaffForEdit(staff);
                              setEditingStaffData({
                                name: staff.name,
                                position: staff.position,
                                status: staff.status || 'Á§æÂì°',
                                startPeriod: staff.startPeriod || { year: new Date().getFullYear(), month: new Date().getMonth() + 1, day: 1 },
                                endPeriod: staff.endPeriod || (staff.status === 'Ê¥æÈÅ£' ? { year: new Date().getFullYear() + 1, month: new Date().getMonth() + 1, day: 1 } : null)
                              });
                              setShowStaffEditModal(false); // Skip staff selection modal
                            }
                          }}
                          className="cursor-pointer hover:text-blue-300 hover:underline transition-all duration-200 px-1 rounded"
                          title={`Edit ${staff.name} - Click to edit staff details`}
                        >
                          {staff.name}
                        </span>
                        {editingColumn === 'delete-mode' && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteColumn(staff.id);
                            }}
                            className="text-red-400 hover:text-red-200 ml-1 border border-red-500 rounded px-1 bg-red-100"
                            title="Delete column"
                          >
                            <X size={12} />
                          </button>
                        )}
                      </div>
                    )}
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          
          {/* Body: Each Row = One Date, Each Column = One Staff Member */}
          <tbody>
            {dateRange.map((date, dateIndex) => {
              const dateKey = format(date, 'yyyy-MM-dd');
              const isWeekend = date.getDay() === 0 || date.getDay() === 6;
              
              return (
                <tr key={dateKey} className="bg-white">
                  {/* Date Cell - Sticky Left Column */}
                  <td className="sticky left-0 z-20 bg-white border-r-2 border-gray-200 min-w-[60px] shadow-sm">
                    <div className="text-center py-1">
                      <div className="font-semibold text-gray-900 text-xs">
                        {format(date, 'dd-MMM')}
                      </div>
                      <div className={`text-xs ${isWeekend ? 'text-red-600 font-medium' : 'text-gray-500'}`}>
                        {format(date, 'EEE', { locale: ja })}
                      </div>
                    </div>
                  </td>
                  
                  {/* Staff Shift Cells - One Column per Staff Member */}
                  {getOrderedStaffMembers.map((staff, staffIndex) => {
                    if (!staff || !staff.id) return null;
                    
                    // Safe access to schedule data
                    const staffSchedule = schedule[staff.id];
                    const shift = staffSchedule && staffSchedule[dateKey] ? staffSchedule[dateKey] : '';
                    
                    
                    // Ensure shift is always a string and handle any objects
                    let shiftValue;
                    try {
                      if (typeof shift === 'string') {
                        shiftValue = shift;
                      } else if (shift && typeof shift === 'object') {
                        if (shift instanceof Error) {
                          shiftValue = 'normal';
                        } else {
                          shiftValue = shift.toString ? shift.toString() : 'normal';
                        }
                      } else {
                        shiftValue = String(shift);
                      }
                    } catch (e) {
                      shiftValue = 'normal';
                    }
                    
                    // Final safety check
                    if (typeof shiftValue !== 'string') {
                      shiftValue = 'normal';
                    }
                    const cellId = `${staff.id}-${dateKey}`;
                    const isDropdownOpen = showDropdown === cellId;
                    const dropdownPosition = getDropdownPosition(date, staffIndex + 1, dateIndex); // Include row index
                    
                    // Dynamic dropdown positioning classes
                    const getDropdownClasses = () => {
                      const baseClasses = "shift-dropdown absolute bg-white border border-gray-300 rounded-lg shadow-lg py-2 min-w-[120px]";
                      
                      switch(dropdownPosition) {
                        case 'right':
                          return `${baseClasses} z-50 left-full top-1/2 transform -translate-y-1/2 ml-1`;
                        case 'left':
                          return `${baseClasses} z-50 right-full top-1/2 transform -translate-y-1/2 mr-1`;
                        case 'left-elevated-top':
                          return `${baseClasses} z-[500] right-full mr-1` + ' ' + 'top-[0%]';
                        case 'below':
                          return `${baseClasses} z-50 top-full left-1/2 transform -translate-x-1/2 mt-1`;
                        default:
                          return `${baseClasses} z-50 top-full left-1/2 transform -translate-x-1/2 mt-1`;
                      }
                    };
                    
                    // Check if date is within work period and if it has START/END label
                    const isWithinWorkPeriod = isDateWithinWorkPeriod(date, staff);
                    const dateLabel = getDateLabel(date, staff);
                    const isStartOrEndDate = dateLabel === 'START' || dateLabel === 'END';
                    
                    return (
                      <td 
                        key={staff.id}
                        className={`text-center relative border-r border-gray-200 ${
                          !isWithinWorkPeriod ? 'bg-gray-100' : 
                          isStartOrEndDate ? 'bg-blue-50' :
                          editingSpecificColumn === staff.id ? 'bg-white' : 
                          isDropdownOpen ? 'ring-2 ring-gray-400 bg-white' : ''
                        }`}
                        style={{ minWidth: '40px', padding: '0' }}
                      >
                        {isWithinWorkPeriod ? (
                          isStartOrEndDate ? (
                            // Non-clickable START/END cell
                            <div 
                              className="w-full h-full py-1 px-1 font-bold bg-blue-50"
                              title={`${staff.name} - ${format(date, 'MMM dd')} - ${dateLabel} Date`}
                            >
                              <div className="relative flex items-center justify-center">
                                <div className={`text-xs font-bold px-2 py-1 rounded ${
                                  dateLabel === 'START' 
                                    ? 'bg-green-500 text-white' 
                                    : 'bg-red-500 text-white'
                                }`}>
                                  {dateLabel}
                                </div>
                              </div>
                            </div>
                          ) : (
                            // Regular clickable cell
                            <div 
                              className={`w-full h-full py-1 px-1 cursor-pointer font-bold ${
                                shiftSymbols[shiftValue]?.color || 'text-gray-600'
                              } ${isDropdownOpen ? '' : 'hover:bg-gray-50'}`}
                              style={{ fontSize: shiftSymbols[shiftValue] ? '1.5rem' : '1rem' }}
                              onClick={(e) => {
                                e.stopPropagation();
                                handleCellClick(staff.id, dateKey);
                              }}
                              title={`${staff.name} - ${format(date, 'MMM dd')} - ${shiftSymbols[shiftValue]?.label || shiftValue}`}
                            >
                              <div className="relative">
                                {shiftSymbols[shiftValue]?.symbol || shiftValue}
                              </div>
                            </div>
                          )
                        ) : (
                          // Blank non-clickable cell for dates outside work period
                          <div 
                            className="w-full h-full py-1 px-1 bg-gray-100"
                            title={`${staff.name} - ${format(date, 'MMM dd')} - Not working`}
                          >
                            <div className="text-gray-400 text-xs">-</div>
                          </div>
                        )}
                        
                        {/* Custom Dropdown with Dynamic Positioning - only show if within work period and not START/END date */}
                        {isDropdownOpen && isWithinWorkPeriod && !isStartOrEndDate && (
                          <div className={getDropdownClasses()}>
                            {getDropdownOrder(staffIndex + 1, staff.name).map((key) => {
                              const value = shiftSymbols[key];
                              if (!value) {
                                return null;
                              }
                              return (
                                <div
                                  key={key}
                                  className={`flex items-center px-3 py-2 hover:bg-gray-100 cursor-pointer ${
                                    shiftValue === key ? 'bg-blue-50 text-blue-600' : ''
                                  }`}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleShiftSelect(staff.id, dateKey, key);
                                  }}
                                >
                                  <span className={`font-bold mr-3 ${value.color}`} style={{ fontSize: '1.2rem' }}>
                                    {value.symbol}
                                  </span>
                                  <span className="text-sm">{value.label}</span>
                                </div>
                              );
                            })}
                            
                            {/* Custom Text Input for all columns */}
                            <div className="border-t border-gray-200 pt-2">
                              <div className="px-3 py-2">
                                <input
                                  type="text"
                                  value={customText}
                                  onChange={(e) => setCustomText(e.target.value)}
                                  onKeyPress={(e) => {
                                    if (e.key === 'Enter' && customText.trim()) {
                                      e.stopPropagation();
                                      handleShiftSelect(staff.id, dateKey, customText.trim());
                                      setCustomText('');
                                    }
                                  }}
                                  onClick={(e) => e.stopPropagation()}
                                  placeholder="Type custom text..."
                                  className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                  autoFocus
                                />
                              </div>
                            </div>
                            
                            {/* Action Buttons - moved to bottom */}
                            <div className="border-t border-gray-200 p-1 flex gap-1">
                              {/* Delete Button - only show if cell has existing text */}
                              {shiftValue && !shiftSymbols[shiftValue] && (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleShiftSelect(staff.id, dateKey, 'normal');
                                  }}
                                  className="flex-1 px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                  title="Delete custom text"
                                >
                                  √ó
                                </button>
                              )}
                              
                              {/* Apply Button */}
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (customText.trim()) {
                                    handleShiftSelect(staff.id, dateKey, customText.trim());
                                    setCustomText('');
                                  }
                                }}
                                disabled={!customText.trim()}
                                className={`flex-1 px-2 py-1 text-xs rounded transition-colors ${
                                  customText.trim() 
                                    ? 'bg-blue-500 text-white hover:bg-blue-600' 
                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                }`}
                                title="Apply custom text"
                              >
                                ‚úì
                              </button>
                            </div>
                          </div>
                        )}
                      </td>
                    );
                  })}
                </tr>
              );
            })}
          </tbody>
          
          {/* Vacation Footer Row */}
          <tfoot>
            <tr className="bg-yellow-100 border-t-2 border-orange-300">
              <td className="sticky left-0 z-20 bg-orange-200 border-r-2 border-orange-300 min-w-[100px] shadow-sm">
                <div className="text-center py-2">
                  <div className="font-bold text-orange-800 text-xs">
                    ‰ºëÊöáÂêàË®à
                  </div>
                  <div className="text-xs text-orange-700">
                    Vacation Total
                  </div>
                </div>
              </td>
              {getOrderedStaffMembers.map(staff => (
                <td key={staff.id} className="text-center py-2 min-w-[70px] border-r border-orange-300 bg-yellow-50">
                  <div className="font-bold text-orange-800 text-sm">
                    {calculateVacationDays(staff.id)}
                  </div>
                  <div className="text-xs text-orange-700">
                    days
                  </div>
                </td>
              ))}
            </tr>
          </tfoot>
        </table>
      </div>

      {/* Statistics Section - Below Table */}
      <div className="statistics-section w-4/5 mx-auto">
        <div className="bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-lg border border-gray-200 shadow-sm mb-6">
          <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <BarChart3 size={24} />
            Áµ±Ë®à„ÉªÂàÜÊûê (Statistics & Analytics)
          </h2>
          

          {/* Staff Work Patterns Table */}
          <div className="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <FileText size={20} />
              „Çπ„Çø„ÉÉ„ÉïÂà•Âã§Âãô„Éë„Çø„Éº„É≥Ë©≥Á¥∞ (Detailed Staff Work Patterns)
            </h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="text-left p-3 font-medium text-gray-700">„Çπ„Çø„ÉÉ„Éï (Staff)</th>
                    <th className="text-center p-3 font-medium text-amber-600">‚ñ≥ Early</th>
                    <th className="text-center p-3 font-medium text-green-600">‚óã Normal</th>
                    <th className="text-center p-3 font-medium text-purple-600">‚óá Late</th>
                    <th className="text-center p-3 font-medium text-gray-600">√ó Off</th>
                    <th className="text-center p-3 font-medium text-blue-600">Work Days</th>
                    <th className="text-center p-3 font-medium text-orange-600">Vacation</th>
                    <th className="text-center p-3 font-medium text-purple-600">Workload</th>
                  </tr>
                </thead>
                <tbody>
                  {getOrderedStaffMembers.map(staff => {
                    const staffStats = statistics.staffStats[staff.id];
                    const workloadPercentage = Math.round((staffStats.workDays / dateRange.length) * 100);
                    return (
                      <tr key={staff.id} className="border-t border-gray-200 hover:bg-gray-50">
                        <td className="p-3 font-medium text-gray-800">{staffStats.name}</td>
                        <td className="p-3 text-center text-amber-600 font-medium">{staffStats.early}</td>
                        <td className="p-3 text-center text-green-600 font-medium">{staffStats.normal}</td>
                        <td className="p-3 text-center text-purple-600 font-medium">{staffStats.late}</td>
                        <td className="p-3 text-center text-gray-600 font-medium">{staffStats.off}</td>
                        <td className="p-3 text-center text-blue-600 font-medium">{staffStats.workDays}</td>
                        <td className="p-3 text-center text-orange-600 font-bold">{staffStats.vacationDays}</td>
                        <td className="p-3 text-center text-purple-600 font-bold">{workloadPercentage}%</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>

    {/* Staff Selection Modal */}
    {showStaffEditModal && (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-lg font-bold text-gray-900">„Çπ„Çø„ÉÉ„ÉïÈÅ∏Êäû (Select Staff)</h3>
            <button
              onClick={() => setShowStaffEditModal(false)}
              className="text-gray-400 hover:text-gray-600 text-2xl"
            >
              √ó
            </button>
          </div>
          
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {getOrderedStaffMembers.map(staff => (
              <button
                key={staff.id}
                onClick={() => {
                  setSelectedStaffForEdit(staff);
                  setEditingStaffData({
                    name: staff.name,
                    position: staff.position,
                    status: staff.status || 'Á§æÂì°',
                    startPeriod: staff.startPeriod || { year: new Date().getFullYear(), month: new Date().getMonth() + 1, day: 1 },
                    endPeriod: staff.endPeriod || (staff.status === 'Ê¥æÈÅ£' ? { year: new Date().getFullYear() + 1, month: new Date().getMonth() + 1, day: 1 } : null)
                  });
                }}
                className="w-full text-left p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-colors flex items-center justify-between"
              >
                <div>
                  <div className="font-medium text-gray-900">{staff.name}</div>
                  <div className="text-sm text-gray-500">{staff.position}</div>
                  <div className="text-xs text-gray-400">
                    {staff.status || 'Á§æÂì°'} | 
                    {staff.startPeriod ? ` ${staff.startPeriod.year}/${staff.startPeriod.month}/${staff.startPeriod.day || 1}` : ' -'} - 
                    {staff.endPeriod ? ` ${staff.endPeriod.year}/${staff.endPeriod.month}/${staff.endPeriod.day || 1}` : ' ÁÑ°ÊúüÈôê'}
                  </div>
                </div>
                <div className={`w-3 h-3 rounded-full ${staff.status === 'Á§æÂì°' ? 'bg-blue-500' : 'bg-orange-500'}`}></div>
              </button>
            ))}
          </div>
        </div>
      </div>
    )}

    {/* Staff Edit Form Modal */}
    {(selectedStaffForEdit || isAddingNewStaff) && (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 p-6">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-lg font-bold text-gray-900">
              {isAddingNewStaff ? '„Çπ„Çø„ÉÉ„ÉïËøΩÂä† (Add Staff)' : '„Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ (Edit Staff)'}
            </h3>
            <button
              onClick={() => {
                setSelectedStaffForEdit(null);
                setIsAddingNewStaff(false);
                setEditingStaffData({
                  name: '',
                  position: '',
                  status: 'Á§æÂì°',
                  startPeriod: { year: new Date().getFullYear(), month: new Date().getMonth() + 1 },
                  endPeriod: { year: new Date().getFullYear() + 1, month: new Date().getMonth() + 1 }
                });
              }}
              className="text-gray-400 hover:text-gray-600 text-2xl"
            >
              √ó
            </button>
          </div>
          
          <div className="space-y-4">
            {/* Name Field */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ÂêçÂâç (Name)
              </label>
              <input
                type="text"
                value={editingStaffData.name}
                onChange={(e) => setEditingStaffData(prev => ({...prev, name: e.target.value}))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="„Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂÖ•Âäõ"
              />
            </div>

            {/* Position Field */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ËÅ∑‰Ωç (Position)
              </label>
              <input
                type="text"
                value={editingStaffData.position}
                onChange={(e) => setEditingStaffData(prev => ({...prev, position: e.target.value}))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="ËÅ∑‰Ωç„ÇíÂÖ•Âäõ"
              />
            </div>

            {/* Status Checkboxes */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                „Çπ„ÉÜ„Éº„Çø„Çπ (Status)
              </label>
              <div className="flex space-x-4">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={editingStaffData.status === 'Á§æÂì°'}
                    onChange={() => setEditingStaffData(prev => ({...prev, status: 'Á§æÂì°'}))}
                    className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Á§æÂì°</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={editingStaffData.status === 'Ê¥æÈÅ£'}
                    onChange={() => setEditingStaffData(prev => ({...prev, status: 'Ê¥æÈÅ£'}))}
                    className="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Ê¥æÈÅ£</span>
                </label>
              </div>
            </div>

            {/* Start Period */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ÈñãÂßãÊúüÈñì (Start Period)
              </label>
              <div className="flex space-x-2">
                {editingStaffData.status === 'Ê¥æÈÅ£' ? (
                  // For Ê¥æÈÅ£: Show current year only (fixed) + month + day selector
                  <>
                    <div className="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 text-center">
                      {new Date().getFullYear()}Âπ¥
                    </div>
                    <select
                      value={editingStaffData.startPeriod.month}
                      onChange={(e) => {
                        const month = parseInt(e.target.value);
                        const maxDays = getDaysInMonth(new Date().getFullYear(), month);
                        const currentDay = editingStaffData.startPeriod.day > maxDays ? 1 : editingStaffData.startPeriod.day;
                        setEditingStaffData(prev => ({
                          ...prev, 
                          startPeriod: {year: new Date().getFullYear(), month, day: currentDay}
                        }));
                      }}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      {Array.from({length: 12}, (_, i) => i + 1).map(month => (
                        <option key={month} value={month}>{month}Êúà</option>
                      ))}
                    </select>
                    <select
                      value={editingStaffData.startPeriod.day}
                      onChange={(e) => setEditingStaffData(prev => ({
                        ...prev, 
                        startPeriod: {...prev.startPeriod, day: parseInt(e.target.value)}
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      {Array.from({length: getDaysInMonth(new Date().getFullYear(), editingStaffData.startPeriod.month)}, (_, i) => i + 1).map(day => (
                        <option key={day} value={day}>{day}Êó•</option>
                      ))}
                    </select>
                  </>
                ) : (
                  // For Á§æÂì°: Show full year range + month + day selector
                  <>
                    <select
                      value={editingStaffData.startPeriod.year}
                      onChange={(e) => {
                        const year = parseInt(e.target.value);
                        const maxDays = getDaysInMonth(year, editingStaffData.startPeriod.month);
                        const currentDay = editingStaffData.startPeriod.day > maxDays ? 1 : editingStaffData.startPeriod.day;
                        setEditingStaffData(prev => ({
                          ...prev, 
                          startPeriod: {...prev.startPeriod, year, day: currentDay}
                        }));
                      }}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      {Array.from({length: new Date().getFullYear() - 2014}, (_, i) => 2015 + i).map(year => (
                        <option key={year} value={year}>{year}Âπ¥</option>
                      ))}
                    </select>
                    <select
                      value={editingStaffData.startPeriod.month}
                      onChange={(e) => {
                        const month = parseInt(e.target.value);
                        const maxDays = getDaysInMonth(editingStaffData.startPeriod.year, month);
                        const currentDay = editingStaffData.startPeriod.day > maxDays ? 1 : editingStaffData.startPeriod.day;
                        setEditingStaffData(prev => ({
                          ...prev, 
                          startPeriod: {...prev.startPeriod, month, day: currentDay}
                        }));
                      }}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      {Array.from({length: 12}, (_, i) => i + 1).map(month => (
                        <option key={month} value={month}>{month}Êúà</option>
                      ))}
                    </select>
                    <select
                      value={editingStaffData.startPeriod.day}
                      onChange={(e) => setEditingStaffData(prev => ({
                        ...prev, 
                        startPeriod: {...prev.startPeriod, day: parseInt(e.target.value)}
                      }))}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      {Array.from({length: getDaysInMonth(editingStaffData.startPeriod.year, editingStaffData.startPeriod.month)}, (_, i) => i + 1).map(day => (
                        <option key={day} value={day}>{day}Êó•</option>
                      ))}
                    </select>
                  </>
                )}
              </div>
            </div>

            {/* End Period */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ÁµÇ‰∫ÜÊúüÈñì (End Period)
              </label>
              <div className="flex space-x-2">
                {editingStaffData.status === 'Ê¥æÈÅ£' ? (
                  // For Ê¥æÈÅ£: Show current year only (fixed) + month + day selector
                  <>
                    <div className="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 text-center">
                      {new Date().getFullYear()}Âπ¥
                    </div>
                    <select
                      value={editingStaffData.endPeriod?.month || ''}
                      onChange={(e) => {
                        const month = parseInt(e.target.value);
                        const maxDays = getDaysInMonth(new Date().getFullYear(), month);
                        setEditingStaffData(prev => ({
                          ...prev, 
                          endPeriod: {year: new Date().getFullYear(), month, day: 1}
                        }));
                      }}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">Êúà„ÇíÈÅ∏Êäû</option>
                      {Array.from({length: 12}, (_, i) => i + 1).map(month => (
                        <option key={month} value={month}>{month}Êúà</option>
                      ))}
                    </select>
                    {editingStaffData.endPeriod?.month && (
                      <select
                        value={editingStaffData.endPeriod?.day || ''}
                        onChange={(e) => setEditingStaffData(prev => ({
                          ...prev, 
                          endPeriod: {...prev.endPeriod, day: parseInt(e.target.value)}
                        }))}
                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        {Array.from({length: getDaysInMonth(new Date().getFullYear(), editingStaffData.endPeriod.month)}, (_, i) => i + 1).map(day => (
                          <option key={day} value={day}>{day}Êó•</option>
                        ))}
                      </select>
                    )}
                  </>
                ) : (
                  // For Á§æÂì°: Show year range (with unlimited option) + conditional month + day selector
                  <>
                    <select
                      value={editingStaffData.endPeriod?.year || ''}
                      onChange={(e) => {
                        const year = e.target.value === '' ? null : parseInt(e.target.value);
                        setEditingStaffData(prev => ({
                          ...prev, 
                          endPeriod: year ? {...(prev.endPeriod || {}), year, month: prev.endPeriod?.month || 1, day: prev.endPeriod?.day || 1} : null
                        }));
                      }}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">-- (ÁÑ°ÊúüÈôê)</option>
                      {Array.from({length: 3}, (_, i) => new Date().getFullYear() + i).map(year => (
                        <option key={year} value={year}>{year}Âπ¥</option>
                      ))}
                    </select>
                    {editingStaffData.endPeriod?.year && (
                      <select
                        value={editingStaffData.endPeriod?.month || ''}
                        onChange={(e) => {
                          const month = e.target.value === '' ? 1 : parseInt(e.target.value);
                          const maxDays = getDaysInMonth(editingStaffData.endPeriod.year, month);
                          const currentDay = editingStaffData.endPeriod.day > maxDays ? 1 : editingStaffData.endPeriod.day || 1;
                          setEditingStaffData(prev => ({
                            ...prev, 
                            endPeriod: {...prev.endPeriod, month, day: currentDay}
                          }));
                        }}
                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        {Array.from({length: 12}, (_, i) => i + 1).map(month => (
                          <option key={month} value={month}>{month}Êúà</option>
                        ))}
                      </select>
                    )}
                    {editingStaffData.endPeriod?.year && editingStaffData.endPeriod?.month && (
                      <select
                        value={editingStaffData.endPeriod?.day || ''}
                        onChange={(e) => setEditingStaffData(prev => ({
                          ...prev, 
                          endPeriod: {...prev.endPeriod, day: parseInt(e.target.value)}
                        }))}
                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        {Array.from({length: getDaysInMonth(editingStaffData.endPeriod.year, editingStaffData.endPeriod.month)}, (_, i) => i + 1).map(day => (
                          <option key={day} value={day}>{day}Êó•</option>
                        ))}
                      </select>
                    )}
                    {!editingStaffData.endPeriod?.year && (
                      <div className="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 text-center">
                        ÁÑ°ÊúüÈôê
                      </div>
                    )}
                  </>
                )}
              </div>
              {editingStaffData.status === 'Á§æÂì°' && (
                <p className="text-xs text-gray-500 mt-1">Á§æÂì°„ÅÆÂ†¥Âêà„ÄÅÁµÇ‰∫ÜÊúüÈñì„ÅØÁÑ°ÊúüÈôê„Å´„Åß„Åç„Åæ„Åô</p>
              )}
              {editingStaffData.status === 'Ê¥æÈÅ£' && (
                <p className="text-xs text-gray-500 mt-1">Ê¥æÈÅ£„ÅÆÂ†¥Âêà„ÄÅ{new Date().getFullYear()}Âπ¥ÂÜÖ„Åß„ÅÆÈñãÂßã„ÉªÁµÇ‰∫ÜÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
              )}
            </div>
          </div>

          {/* Action Buttons */}
          <div className="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
            <button
              onClick={() => {
                setSelectedStaffForEdit(null);
                setIsAddingNewStaff(false);
                setEditingStaffData({
                  name: '',
                  position: '',
                  status: 'Á§æÂì°',
                  startPeriod: { year: new Date().getFullYear(), month: new Date().getMonth() + 1 },
                  endPeriod: { year: new Date().getFullYear() + 1, month: new Date().getMonth() + 1 }
                });
              }}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
            >
              „Ç≠„É£„É≥„Çª„É´
            </button>
            <button
              onClick={() => {
                if (isAddingNewStaff) {
                  // Create new staff member (modal closing handled in createNewStaff)
                  createNewStaff(editingStaffData);
                } else {
                  // Update existing staff member
                  const updatedStaffMembers = staffMembers.map(staff => 
                    staff.id === selectedStaffForEdit.id 
                      ? { 
                          ...staff, 
                          name: editingStaffData.name,
                          position: editingStaffData.position,
                          status: editingStaffData.status,
                          startPeriod: editingStaffData.startPeriod,
                          endPeriod: editingStaffData.endPeriod
                        }
                      : staff
                  );
                  
                  // Use startTransition for immediate UI update
                  React.startTransition(() => {
                    setStaffMembers(updatedStaffMembers);
                    setStaffMembersByMonth(prev => ({
                      ...prev,
                      [currentMonthIndex]: updatedStaffMembers
                    }));
                  });
                  
                  // Auto-save to database asynchronously
                  setTimeout(() => {
                    scheduleAutoSave(schedule, updatedStaffMembers);
                  }, 0);
                  
                  // Close modal
                  setSelectedStaffForEdit(null);
                  setIsAddingNewStaff(false);
                  setShowStaffEditModal(false);
                  setEditingStaffData({
                    name: '',
                    position: '',
                    status: 'Á§æÂì°',
                    startPeriod: { 
                      year: monthPeriods[currentMonthIndex].start.getFullYear(), 
                      month: monthPeriods[currentMonthIndex].start.getMonth() + 1, 
                      day: monthPeriods[currentMonthIndex].start.getDate() 
                    },
                    endPeriod: { year: new Date().getFullYear() + 1, month: new Date().getMonth() + 1, day: 1 }
                  });
                }
              }}
              className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              {isAddingNewStaff ? 'ËøΩÂä†' : '‰øùÂ≠ò'}
            </button>
          </div>
        </div>
      </div>
    )}


    </>
  );
};

export default ShiftScheduleEditor;