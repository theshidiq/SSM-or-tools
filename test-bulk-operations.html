<!DOCTYPE html>
<html>
<head>
    <title>Bulk Operations Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-button { 
            padding: 10px 20px; 
            margin: 10px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 4px;
        }
        .test-button:hover { background: #45a049; }
        .console { 
            background: #f5f5f5; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 4px; 
            max-height: 400px; 
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bulk Operations Debugging Test</h1>
        <p>This test simulates the bulk operations issue to verify the fix works correctly.</p>
        
        <div id="status" class="status info">
            Click the test button to simulate bulk operations on multiple selected cells.
        </div>

        <button class="test-button" onclick="testBulkOperations()">Test Bulk Operations</button>
        <button class="test-button" onclick="clearConsole()">Clear Console</button>
        
        <h3>Console Output:</h3>
        <div id="console" class="console">Waiting for test...</div>
    </div>

    <script>
        let consoleOutput = [];
        
        function log(message) {
            consoleOutput.push(new Date().toLocaleTimeString() + ': ' + message);
            document.getElementById('console').textContent = consoleOutput.join('\n');
        }
        
        function clearConsole() {
            consoleOutput = [];
            document.getElementById('console').textContent = 'Console cleared...';
        }
        
        function testBulkOperations() {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status info';
            statusEl.textContent = 'Running bulk operations test...';
            
            // Simulate the exact issue scenario
            const selectedCells = new Set(['staff1-2025-01-15', 'staff2-2025-01-15', 'staff3-2025-01-15']);
            const scheduleData = {
                'staff1': { '2025-01-15': '' },
                'staff2': { '2025-01-15': '' },
                'staff3': { '2025-01-15': '' }
            };
            
            log('üîß applyToSelected called with: ‚óã');
            log('üìã Selected cells: ' + Array.from(selectedCells).join(', '));
            log('üìä Current scheduleData: ' + JSON.stringify(scheduleData));
            
            // Simulate the fixed version
            const newSchedule = JSON.parse(JSON.stringify(scheduleData));
            let updatedCount = 0;
            
            selectedCells.forEach(cellKey => {
                const [staffId, dateKey] = cellKey.split('-').slice(0, 1).concat(cellKey.split('-').slice(1));
                const actualStaffId = cellKey.split('-')[0];
                const actualDateKey = cellKey.split('-').slice(1).join('-');
                
                log(`üéØ Updating: ${actualStaffId} -> ${actualDateKey} = ‚óã`);
                
                if (!newSchedule[actualStaffId]) {
                    newSchedule[actualStaffId] = {};
                }
                
                newSchedule[actualStaffId][actualDateKey] = '‚óã';
                updatedCount++;
            });
            
            log('üîÑ Applying batched update to ' + selectedCells.size + ' cells');
            log('üìä New schedule object: ' + JSON.stringify(newSchedule));
            log('‚úÖ applyToSelected completed');
            
            // Verify all cells were updated
            let successCount = 0;
            selectedCells.forEach(cellKey => {
                const actualStaffId = cellKey.split('-')[0];
                const actualDateKey = cellKey.split('-').slice(1).join('-');
                
                if (newSchedule[actualStaffId] && newSchedule[actualStaffId][actualDateKey] === '‚óã') {
                    successCount++;
                }
            });
            
            if (successCount === selectedCells.size) {
                statusEl.className = 'status success';
                statusEl.textContent = `‚úÖ SUCCESS: All ${selectedCells.size} cells were updated correctly!`;
                log(`‚úÖ VERIFICATION: All ${selectedCells.size} cells updated successfully`);
            } else {
                statusEl.className = 'status error';
                statusEl.textContent = `‚ùå ERROR: Only ${successCount} out of ${selectedCells.size} cells were updated!`;
                log(`‚ùå VERIFICATION: Only ${successCount} out of ${selectedCells.size} cells updated`);
            }
        }
        
        // Run test automatically on load
        window.onload = function() {
            setTimeout(testBulkOperations, 1000);
        };
    </script>
</body>
</html>