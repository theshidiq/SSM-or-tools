<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Autosave Integration</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Supabase Autosave Integration</h1>
    
    <div>
        <button onclick="testConnection()">1. Test Connection</button>
        <button onclick="checkTables()">2. Check Tables</button>
        <button onclick="testConfigService()">3. Test ConfigService</button>
        <button onclick="testAutosave()">4. Test Autosave</button>
        <button onclick="checkDatabase()">5. Check Database</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="logs"></div>

    <script type="module">
        // Import Supabase client directly
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Configuration from environment (you'll need to replace with actual values)
        const supabaseUrl = 'https://ymdyejrljmvajqjbejvh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltZHllanJsam12YWpxamJlanZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MjE1NDMsImV4cCI6MjA2ODI5NzU0M30.wFirIfjnpkgRqDhECW6XZKkzWg_Q-pvs7jX_FIAMYfE';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        window.supabase = supabase;

        function log(type, message, data = null) {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            
            let content = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            if (data) {
                content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            logDiv.innerHTML = content;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        window.log = log;

        window.testConnection = async function() {
            log('info', 'üîç Testing Supabase connection...');
            
            try {
                const { data, error } = await supabase
                    .from('restaurants')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log('error', '‚ùå Connection failed', error);
                    return;
                }
                
                log('success', '‚úÖ Supabase connection successful');
            } catch (error) {
                log('error', '‚ùå Connection error', error);
            }
        };

        window.checkTables = async function() {
            log('info', 'üìã Checking all required tables...');
            
            const requiredTables = [
                'restaurants',
                'config_versions', 
                'staff_groups',
                'daily_limits',
                'monthly_limits',
                'priority_rules',
                'ml_model_configs'
            ];

            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('count')
                        .limit(1);
                    
                    if (error) {
                        log('error', `‚ùå Table '${table}' error`, error);
                    } else {
                        log('success', `‚úÖ Table '${table}' exists`);
                    }
                } catch (err) {
                    log('error', `‚ùå Table '${table}' exception`, err);
                }
            }
        };

        window.testConfigService = function() {
            log('info', 'üîß Testing ConfigurationService...');
            
            // Check if we can access the service
            if (typeof window.configService !== 'undefined') {
                const status = window.configService.getSyncStatus();
                log('success', '‚úÖ ConfigurationService found', status);
            } else {
                log('warning', '‚ö†Ô∏è ConfigurationService not found in window. Checking localStorage...');
                
                // Check localStorage settings
                const settings = localStorage.getItem('shift-schedule-settings');
                if (settings) {
                    const parsed = JSON.parse(settings);
                    log('info', 'üì± Found localStorage settings', {
                        staffGroups: parsed.staffGroups?.length || 0,
                        dailyLimits: parsed.dailyLimits?.length || 0,
                        monthlyLimits: parsed.monthlyLimits?.length || 0,
                        priorityRules: parsed.priorityRules?.length || 0,
                        lastSyncedAt: parsed.lastSyncedAt
                    });
                } else {
                    log('warning', '‚ö†Ô∏è No localStorage settings found');
                }
            }
        };

        window.testAutosave = async function() {
            log('info', 'üíæ Testing manual save to database...');
            
            try {
                // 1. First check if restaurant exists
                let { data: restaurants, error: restaurantError } = await supabase
                    .from('restaurants')
                    .select('*');
                
                if (restaurantError) {
                    log('error', '‚ùå Failed to check restaurants', restaurantError);
                    return;
                }
                
                let restaurantId;
                if (!restaurants || restaurants.length === 0) {
                    log('info', 'üè™ Creating restaurant...');
                    const { data: newRestaurant, error: createError } = await supabase
                        .from('restaurants')
                        .insert([{
                            name: 'Debug Test Restaurant',
                            timezone: 'Asia/Tokyo'
                        }])
                        .select();
                    
                    if (createError) {
                        log('error', '‚ùå Failed to create restaurant', createError);
                        return;
                    }
                    
                    restaurantId = newRestaurant[0].id;
                    log('success', '‚úÖ Restaurant created', { id: restaurantId });
                } else {
                    restaurantId = restaurants[0].id;
                    log('success', '‚úÖ Using existing restaurant', { id: restaurantId });
                }

                // 2. Create config version
                log('info', 'üìù Creating config version...');
                const { data: configVersion, error: configError } = await supabase
                    .from('config_versions')
                    .insert([{
                        restaurant_id: restaurantId,
                        version_number: 1,
                        name: 'Debug Test Configuration',
                        description: 'Test configuration for debugging autosave',
                        is_active: true,
                        is_locked: false
                    }])
                    .select();
                
                if (configError) {
                    log('error', '‚ùå Failed to create config version', configError);
                    return;
                }
                
                const versionId = configVersion[0].id;
                log('success', '‚úÖ Config version created', { id: versionId });

                // 3. Test saving staff groups
                log('info', 'üë• Testing staff groups save...');
                const { data: staffGroup, error: staffError } = await supabase
                    .from('staff_groups')
                    .insert([{
                        restaurant_id: restaurantId,
                        version_id: versionId,
                        name: 'Debug Test Group',
                        description: 'Test group for debugging',
                        group_config: {
                            color: '#FF0000',
                            members: ['Test Staff 1', 'Test Staff 2']
                        }
                    }])
                    .select();
                
                if (staffError) {
                    log('error', '‚ùå Failed to save staff group', staffError);
                    return;
                }
                
                log('success', '‚úÖ Staff group saved successfully', staffGroup[0]);

            } catch (error) {
                log('error', '‚ùå Autosave test failed', error);
            }
        };

        window.checkDatabase = async function() {
            log('info', 'üóÑÔ∏è Checking database contents...');
            
            try {
                // Check restaurants
                const { data: restaurants } = await supabase
                    .from('restaurants')
                    .select('*');
                log('info', `üè™ Restaurants: ${restaurants?.length || 0}`, restaurants);

                // Check config versions
                const { data: configVersions } = await supabase
                    .from('config_versions')
                    .select('*');
                log('info', `üìù Config versions: ${configVersions?.length || 0}`, configVersions);

                // Check staff groups
                const { data: staffGroups } = await supabase
                    .from('staff_groups')
                    .select('*');
                log('info', `üë• Staff groups: ${staffGroups?.length || 0}`, staffGroups);

                // Check daily limits
                const { data: dailyLimits } = await supabase
                    .from('daily_limits')
                    .select('*');
                log('info', `üìÖ Daily limits: ${dailyLimits?.length || 0}`, dailyLimits);

            } catch (error) {
                log('error', '‚ùå Database check failed', error);
            }
        };

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        };

        // Auto-test on load
        log('info', 'üöÄ Debug tool loaded. Click buttons to test each component.');
    </script>
</body>
</html>