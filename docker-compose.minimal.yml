# Minimal Docker Compose Configuration
# Optimized for cost-effective deployment on Railway.app, Fly.io, or Render.com
# Total Resources: ~1.3GB RAM, 2 CPU cores
#
# Services included:
# - nginx (React static files)
# - go-websocket-server (1 replica)
# - ortools-optimizer
# - External Supabase (no local postgres)
#
# Quick start:
#   docker-compose -f docker-compose.minimal.yml up --build

services:
  # Nginx reverse proxy and React static files
  nginx:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: shift-schedule-nginx-minimal
    ports:
      - "80:80"
    environment:
      - REACT_APP_SUPABASE_URL=${REACT_APP_SUPABASE_URL}
      - REACT_APP_SUPABASE_ANON_KEY=${REACT_APP_SUPABASE_ANON_KEY}
      - REACT_APP_WEBSOCKET_URL=${REACT_APP_WEBSOCKET_URL:-ws://localhost:8080}
      - REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL:-http://localhost/api}
      - REACT_APP_ENVIRONMENT=production
      - REACT_APP_VERSION=${APP_VERSION:-1.0.0}
    networks:
      - app-network
    depends_on:
      - go-websocket-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M  # Reduced from 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # Go WebSocket Server (single replica for cost optimization)
  go-websocket-server:
    build:
      context: ./go-server
      dockerfile: Dockerfile
    container_name: go-websocket-server-minimal
    ports:
      - "8080:8080"
    environment:
      - SUPABASE_URL=${REACT_APP_SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - WEBSOCKET_PORT=8080
      - GO_ENV=production
      - GOMAXPROCS=${GOMAXPROCS:-1}
      - GOGC=${GOGC:-100}
      - WEBSOCKET_READ_BUFFER_SIZE=1024
      - WEBSOCKET_WRITE_BUFFER_SIZE=1024
      - MAX_CONNECTIONS=100  # Reduced from 1000 for minimal deployment
      - ORTOOLS_SERVICE_URL=http://ortools-optimizer:5000
    networks:
      - app-network
    depends_on:
      - ortools-optimizer
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  # OR-Tools Schedule Optimizer Service
  ortools-optimizer:
    build:
      context: ./python-ortools-service
      dockerfile: Dockerfile
    container_name: ortools-optimizer-minimal
    ports:
      - "5050:5000"
    environment:
      - PYTHONUNBUFFERED=1
      - ORTOOLS_WORKERS=2  # Reduced from 4 for memory optimization
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M  # Reduced from 1GB
          cpus: '1.0'   # Reduced from 2.0
        reservations:
          memory: 256M
          cpus: '0.5'

# Network configuration
networks:
  app-network:
    driver: bridge

# Notes for deployment platforms:
#
# Railway.app deployment:
#   - Total cost: ~$15/month (3 services × $5)
#   - Auto-deploy from GitHub
#   - Environment variables set in Railway dashboard
#   - Custom domain + SSL included free
#
# Fly.io deployment:
#   - Can fit in free tier (3 × 256MB VMs)
#   - Use fly.toml configuration
#   - Scale down OR-Tools to 256MB if needed
#
# Render.com deployment:
#   - nginx as static site: FREE
#   - go-websocket-server: $7/month (Starter)
#   - ortools-optimizer: $7/month (Starter)
#   - Total: $14/month
#
# Resource requirements comparison:
#   Full production (docker-compose.yml): 11.5GB RAM, 11.5 CPU cores
#   Minimal (this file): 1.3GB RAM, 2.5 CPU cores
#   Reduction: 88% RAM savings, 78% CPU savings
