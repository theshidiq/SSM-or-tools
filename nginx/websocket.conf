# Phase 5: WebSocket Configuration for Go Server Load Balancing
# Specification from IMPLEMENTATION_PLAN_HYBRID_ARCHITECTURE.md lines 561-593

# WebSocket upstream configuration with load balancing
upstream websocket_backend {
    # Load balancing method - ip_hash for sticky sessions
    ip_hash;

    # Go WebSocket server replicas (3 replicas as per Phase 5 spec)
    server go-websocket-server_1:8080 max_fails=3 fail_timeout=30s weight=1;
    server go-websocket-server_2:8080 max_fails=3 fail_timeout=30s weight=1;
    server go-websocket-server_3:8080 max_fails=3 fail_timeout=30s weight=1;

    # Connection persistence for WebSocket sessions
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# WebSocket location configuration
location /ws/ {
    # Phase 5: WebSocket proxy configuration as per spec
    proxy_pass http://websocket_backend;

    # Essential WebSocket headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Phase 5: Timeout settings for WebSocket connections
    proxy_connect_timeout 10s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # WebSocket-specific settings
    proxy_buffering off;
    proxy_cache off;
    proxy_set_header Cache-Control 'no-cache';

    # Connection upgrade handling
    proxy_cache_bypass $http_upgrade;

    # Rate limiting for WebSocket connections
    limit_req zone=websocket burst=50 nodelay;

    # Security headers for WebSocket endpoints
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
}

# WebSocket health check endpoint
location /ws/health {
    proxy_pass http://websocket_backend/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Quick timeout for health checks
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;

    access_log off;
}

# WebSocket rate limiting zone
limit_req_zone $binary_remote_addr zone=websocket:10m rate=20r/s;