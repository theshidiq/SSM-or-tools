# Portfolio-Optimized Docker Compose
# Optimized for 20 concurrent users (realistic hotel production)
# Total Resources: 576MB RAM, 1.75 vCPU
# Cost: $0/month (Fly.io) or $8.5/month (AWS t2.micro)
#
# Usage: docker-compose -f docker-compose.portfolio.yml up --build
#
# Removed services:
# - ai-server (legacy TensorFlow.js - replaced by OR-Tools)
# - redis (not needed for <100 users - Go uses in-memory cache)
# - postgres (using Supabase instead)
# - prometheus/grafana/loki (monitoring not needed for portfolio)

services:
  # NGINX - Static files + Reverse proxy (64MB)
  nginx:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: shift-schedule-nginx
    ports:
      - "80:80"
    environment:
      - REACT_APP_SUPABASE_URL=${REACT_APP_SUPABASE_URL:-}
      - REACT_APP_SUPABASE_ANON_KEY=${REACT_APP_SUPABASE_ANON_KEY:-}
      - REACT_APP_WEBSOCKET_URL=${REACT_APP_WEBSOCKET_URL:-ws://localhost:8080}
      - REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL:-http://localhost/api}
      - REACT_APP_ENVIRONMENT=production
    networks:
      - app-network
    depends_on:
      go-websocket-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.25'
        reservations:
          memory: 32M

  # Go WebSocket Server - Real-time communication (256MB)
  # Single replica handles 100+ concurrent connections
  go-websocket-server:
    build:
      context: ./go-server
      dockerfile: Dockerfile
    container_name: go-websocket-server
    ports:
      - "8080:8080"
    environment:
      - SUPABASE_URL=${REACT_APP_SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - WEBSOCKET_PORT=8080
      - GO_ENV=production
      - GOMAXPROCS=1
      - MAX_CONNECTIONS=100
      - ORTOOLS_SERVICE_URL=http://ortools-optimizer:5000
    networks:
      - app-network
    depends_on:
      ortools-optimizer:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M

  # OR-Tools Optimizer - Schedule generation (256MB)
  # Google CP-SAT solver for 15-30 staff members
  ortools-optimizer:
    build:
      context: ./python-ortools-service
      dockerfile: Dockerfile
    container_name: ortools-optimizer
    ports:
      - "5050:5000"
    environment:
      - PYTHONUNBUFFERED=1
      - ORTOOLS_WORKERS=2
      - MEMORY_LIMIT_MB=256
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M

networks:
  app-network:
    driver: bridge

# ============================================================
# DEPLOYMENT SUMMARY
# ============================================================
#
# Total Resources:
#   - RAM: 576MB (64 + 256 + 256)
#   - vCPU: 1.75 cores (0.25 + 0.5 + 1.0)
#
# Capacity:
#   - Concurrent Users: 20 (can grow to 100)
#   - Staff Optimization: 15-30 staff members
#   - Schedule Generation: 2-8 seconds
#
# Platform Costs:
#   - AWS t2.micro (1GB): FREE (12 months) or $8.50/month
#   - Fly.io: $0/month (fits in free tier)
#   - Railway: $5-10/month
#   - Render: $7/month
#
# Compared to full production:
#   - RAM: 12.8GB -> 576MB (95% reduction)
#   - Cost: $128/month -> $0-10/month (93-100% savings)
#   - Performance: Maintained (<50ms UI, <100ms WebSocket)
# ============================================================
